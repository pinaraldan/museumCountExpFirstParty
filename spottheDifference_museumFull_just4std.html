<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot the Difference Experiment</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css">
    <style>
   body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        .instructions {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .image-comparison {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .image-container {
            text-align: center;
            width: 45%;
            max-width: 500px;
        }
        
        .comparison-image {
            max-width: 100%;
            height: auto;
            border: 2px solid #333;
            border-radius: 5px;
        }
        
        .hotspot {
            position: absolute;
            background-color: transparent;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .hotspot.found {
            background-color: rgba(0, 255, 0, 0.3);
            border-color: green;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .image-comparison {
                flex-direction: column;
                align-items: center;
            }
            
            .comparison-image {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <script>
        // Initialize jsPsych
        const jsPsych = initJsPsych({
            on_finish: function() {
                console.log('Experiment finished');
            }
        });

        // Cache buster for images and audio
        const cacheBuster = '?v=' + Date.now();
        
        // Generate random participant ID
        const participantID = Math.floor(100000 + Math.random() * 900000);
        






        // Function to get a fresh copy of first training differences array (using preTrain images)
        function getFreshDifferencesTrainingFirst() {
            const freshDifferences = [
               { id: 1, x: 8, y: 8, size: 50, found: false },
                { id: 2, x: 90, y: 10, size: 70, found: false },
                { id: 3, x: 60, y: 40, size: 55, found: false },
                { id: 4, x: 42, y: 35, size: 60, found: false }
            ].map(diff => ({ ...diff })); // Ensure completely fresh objects
            
            return freshDifferences;
        }

        // Function to get a fresh copy of second training differences array (using t2 images)
        function getFreshDifferencesTraining() {
            const freshDifferences = [
                { id: 1, x: 21, y: 30, size: 65, found: false },
                { id: 2, x: 63, y: 46, size: 100, found: false },
                { id: 3, x: 58, y: 13, size: 50, found: false },
                { id: 4, x: 43, y: 29, size: 60, found: false }
            ].map(diff => ({ ...diff })); // Ensure completely fresh objects
            
            return freshDifferences;
        }

        // Define differences for each trial
       const differences = [
            { id: 1, x: 2, y: 37, size: 50, found: false },
            { id: 2, x: 4, y: 10, size: 40, found: false },
            { id: 3, x: 25, y: 25, size: 40, found: false },
            { id: 4, x: 71, y: 33, size: 40, found: false },
            { id: 5, x: 86, y: 38, size: 40, found: false },
            { id: 6, x: 92, y: 10, size: 40, found: false }
        ];

        const differencesA = [
            { id: 2, x: 17, y: 41, size: 40, found: false },
            { id: 1, x: 1, y: 37, size: 55, found: false },
            { id: 3, x: 29, y: 30, size: 40, found: false },
            { id: 5, x: 75, y: 24, size: 45, found: false },
            { id: 4, x: 66, y: 10,  size: 50, found: false },
            { id: 6, x: 90, y: 49, size: 60, found: false }
        ];

        const differencesB = [
            { id: 1, x: 5, y: 57, size: 50, found: false },
            { id: 2, x: 4, y: 4, size: 50, found: false },
            { id: 3, x: 24, y: 38, size: 40, found: false },
            { id: 4, x: 55, y: 52, size: 50, found: false },
            { id: 5, x: 70, y: 1, size: 50, found: false },
            { id: 6, x: 81, y: 40, size: 40, found: false }
        ];

        // New trials C and D
        const differences3 = [
            { id: 1, x: 2, y: 37, size: 50, found: false },
            { id: 2, x: 8, y: 13, size: 40, found: false },
            { id: 3, x: 25, y: 29, size: 40, found: false },
            { id: 4, x: 71, y: 37, size: 40, found: false },
            { id: 5, x: 84, y: 38, size: 40, found: false },
            { id: 6, x: 92, y: 12, size: 40, found: false }
        ];

        const differences4 = [
            { id: 3, x: 33, y: 64, size: 45, found: false },
            { id: 1, x: 18, y: 17, size: 50, found: false },
            { id: 2, x: 37, y: 19, size: 45, found: false },
            { id: 4, x: 68, y: 18, size: 45, found: false },
            { id: 5, x: 84, y: 53, size: 45, found: false },
            { id: 6, x: 89, y: 20, size: 60, found: false }
        ];

        // Create timeline
        const timeline = [];
        
        // Add CSS to ensure all option images are clickable
        const style = document.createElement('style');
        style.textContent = `
            .option-image {
                user-select: none !important;
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                pointer-events: auto !important;
                cursor: pointer !important;
            }
            .option-container {
                cursor: pointer !important;
            }
            .right-highlight {
                box-shadow: 0 0 0 6px #ffe066, 0 0 20px rgba(255, 224, 102, 0.9);
                border-radius: 10px;
                transition: box-shadow 0.15s ease;
            }
        `;
        document.head.appendChild(style);

        // === DEMOGRAPHIC INFORMATION FORM ===
        // Store demographic info globally so it persists
        let demographicInfo = {
            participant_number: '',
            participant_gender: '',
            participant_age: '',
            test_date: ''
        };
        
        const demographic_form = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 20px;">
                    <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 600px; width: 100%;">
                        <h2 style="text-align: center; color: #333; margin-bottom: 30px; font-size: 28px;">Participant Information</h2>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="participant-number" style="display: block; font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #555;">Participant Number:</label>
                            <input type="text" id="participant-number" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box;" placeholder="Enter participant number">
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="participant-gender" style="display: block; font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #555;">Participant Gender:</label>
                            <input type="text" id="participant-gender" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box;" placeholder="Enter gender">
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="participant-age" style="display: block; font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #555;">Participant Age:</label>
                            <input type="text" id="participant-age" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box;" placeholder="Enter age">
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="test-date" style="display: block; font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #555;">Date of Test:</label>
                            <input type="date" id="test-date" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                        </div>
                    </div>
                </div>
            `,
            choices: ['Next'],
            button_html: '<button class="jspsych-btn" id="demographic-next-btn" style="font-size: 20px; padding: 15px 40px; margin-top: 20px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">%choice%</button>',
            on_load: function() {
                // Capture values when Next button is clicked, before trial ends
                const nextBtn = document.getElementById('demographic-next-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', function() {
                        demographicInfo.participant_number = document.getElementById('participant-number').value;
                        demographicInfo.participant_gender = document.getElementById('participant-gender').value;
                        demographicInfo.participant_age = document.getElementById('participant-age').value;
                        demographicInfo.test_date = document.getElementById('test-date').value;
                        
                        console.log('Demographic info captured:', demographicInfo);
                    });
                }
            },
            on_finish: function(data) {
                // Save demographic information to all subsequent trials
                jsPsych.data.addProperties({
                    participant_number: demographicInfo.participant_number,
                    participant_gender: demographicInfo.participant_gender,
                    participant_age: demographicInfo.participant_age,
                    test_date: demographicInfo.test_date
                });
                
                console.log('Demographic info saved to jsPsych data');
            }
        };

        // === WELCOME BLOCK ===
        const welcome_block = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/welcome.png${cacheBuster}" alt="Welcome" style="max-width: 80vw; max-height: 50vh; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };
        // === END WELCOME BLOCK ===

        timeline.push(demographic_form);
        timeline.push(welcome_block);

     
       

        // === ISLAND INTRO BLOCK ===
        const islandIntro = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/island.png${cacheBuster}" alt="Island" style="max-width: 90vw; max-height: 60vh; width: auto; height: auto; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };
        // === END ISLAND INTRO BLOCK ===

        // timeline.push(islandIntro); // removed per reduced block list

        // === GROUPS INTRO BLOCK ===
        const groupsIntro = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/islandAndKids.png${cacheBuster}" alt="Island and Kids" style="max-width: 90vw; max-height: 60vh; width: auto; height: auto; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };
        // === END GROUPS INTRO BLOCK ===

        // timeline.push(groupsIntro); // removed per reduced block list

        // === GREEN TEAM LOVES MIPPO BLOCK ===
        const greenTeamLovesMippo = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/greenTeamLovesMippo.png${cacheBuster}" alt="Green Team Loves Mippo" style="max-width: 90vw; max-height: 60vh; width: auto; height: auto; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };
        // === END GREEN TEAM LOVES MIPPO BLOCK ===

        // === ORANGE TEAM LOVES TUVVY BLOCK ===
        const orangeTeamLovesTuvvy = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/orangeTeamLovesTuvvy.png${cacheBuster}" alt="Orange Team Loves Tuvvy" style="max-width: 90vw; max-height: 60vh; width: auto; height: auto; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };
        // === END ORANGE TEAM LOVES TUVVY BLOCK ===

        // === GUESSING GAME INTRO BLOCK ===
        const guessingGameIntro = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/guessingGameIntro.png${cacheBuster}" alt="Guessing Game Intro" style="max-width: 90vw; max-height: 60vh; width: auto; height: auto; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };
        // === END GUESSING GAME INTRO BLOCK ===

        // === DRAG AND DROP TRAINING BLOCK ===
        const dragAndDropTraining = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <style>
                    .drag-container {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 20px;
                        padding: 20px;
                        max-width: 1200px;
                        margin: 0 auto;
                    }
                    
                    .current-image-container {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 15px;
                        margin-bottom: 30px;
                    }
                    
                    .current-image {
                        max-width: 300px;
                        max-height: 300px;
                        width: auto;
                        height: auto;
                        border-radius: 15px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .current-image:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
                    }
                    
                    .current-image.selected {
                        border: 5px solid #ffeb3b;
                        box-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
                        transform: scale(1.05);
                    }
                    
                    .current-image.dragging {
                        opacity: 0.5;
                        transform: scale(1.1);
                    }
                    
                    .drop-zones-container {
                        display: flex;
                        gap: 40px;
                        justify-content: center;
                        margin-bottom: 30px;
                    }
                    
                    .drop-zone {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 15px;
                    }
                    
                    .character-image {
                        max-width: 150px;
                        max-height: 150px;
                        width: auto;
                        height: auto;
                        border-radius: 10px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .drop-box {
                        width: 300px;
                        min-height: 200px;
                        border: 3px dashed #ccc;
                        border-radius: 15px;
                        background-color: #f9f9f9;
                        transition: all 0.3s ease;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                        padding: 15px;
                        align-items: flex-start;
                        justify-content: flex-start;
                        cursor: pointer;
                    }
                    
                    .drop-box.dragover {
                        border-color: #2ecc40;
                        background-color: #e8f5e8;
                    }
                    
                    .drop-box:hover {
                        border-color: #999;
                        background-color: #f5f5f5;
                    }
                    
                    .dropped-image {
                        max-width: 120px;
                        max-height: 120px;
                        width: auto;
                        height: auto;
                        border-radius: 8px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                        flex-shrink: 0;
                    }
                    
                    .refresh-btn {
                        background-color: #3498db;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        padding: 10px 20px;
                        font-size: 1em;
                        cursor: pointer;
                        transition: background-color 0.3s ease;
                        margin-top: 20px;
                    }
                    
                    .refresh-btn:hover {
                        background-color: #2980b9;
                    }
                </style>
                
                <div class="drag-container">
                    <div class="current-image-container">
                        <img id="current-image" class="current-image" draggable="true" src="img/silhouette.png${cacheBuster}" alt="Silhouette">
                    </div>
                    
                    <div class="drop-zones-container">
                        <div class="drop-zone">
                            <img class="character-image" src="img/mippoSQ.png${cacheBuster}" alt="Mippo">
                            <div class="drop-box" id="mippo-box">
                                <!-- Dropped images will appear here -->
                            </div>
                        </div>
                        
                        <div class="drop-zone">
                            <img class="character-image" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy">
                            <div class="drop-box" id="tuvvy-box">
                                <!-- Dropped images will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <button class="refresh-btn" id="refresh-btn">Refresh</button>
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const currentImage = document.getElementById('current-image');
                const mippoBox = document.getElementById('mippo-box');
                const tuvvyBox = document.getElementById('tuvvy-box');
                const refreshBtn = document.getElementById('refresh-btn');
                const nextBtn = document.getElementById('custom-next-btn');
                
                // Hide default jsPsych button
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                // Tap-to-select, tap-to-place functionality (easier for tablets)
                let imageSelected = false;
                
                // Click/tap on image to select it
                currentImage.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (currentImage.style.display !== 'none') {
                        imageSelected = true;
                        this.classList.add('selected');
                    }
                });
                
                // Click/tap on drop boxes to place image
                [mippoBox, tuvvyBox].forEach(box => {
                    box.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (imageSelected) {
                            // Add silhouette to the box
                            const droppedImg = document.createElement('img');
                            droppedImg.src = `img/silhouette.png${cacheBuster}`;
                            droppedImg.className = 'dropped-image';
                            droppedImg.alt = 'Silhouette';
                            this.appendChild(droppedImg);
                            
                            // Hide the original image
                            currentImage.style.display = 'none';
                            currentImage.classList.remove('selected');
                            imageSelected = false;
                            
                            // Record the response
                            jsPsych.data.addProperties({
                                training_drag_drop_box: this.id,
                                training_drag_drop_trial: 'training'
                            });
                        }
                    });
                });
                
                // Keep drag functionality for desktop (mouse)
                currentImage.addEventListener('dragstart', function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', 'silhouette.png');
                });
                
                currentImage.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                // Drop zone functionality (mouse)
                [mippoBox, tuvvyBox].forEach(box => {
                    box.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.classList.add('dragover');
                    });
                    
                    box.addEventListener('dragleave', function() {
                        this.classList.remove('dragover');
                    });
                    
                    box.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('dragover');
                        
                        // Add silhouette to the box
                        const droppedImg = document.createElement('img');
                        droppedImg.src = `img/silhouette.png${cacheBuster}`;
                        droppedImg.className = 'dropped-image';
                        droppedImg.alt = 'Silhouette';
                        this.appendChild(droppedImg);
                        
                        // Hide the original image
                        currentImage.style.display = 'none';
                        
                        // Record the response
                        jsPsych.data.addProperties({
                            training_drag_drop_box: this.id,
                            training_drag_drop_trial: 'training'
                        });
                    });
                });
                
                // Refresh functionality
                refreshBtn.addEventListener('click', function() {
                    // Remove all dropped images
                    mippoBox.innerHTML = '';
                    tuvvyBox.innerHTML = '';
                    
                    // Show the original image again and reset selection
                    currentImage.style.display = 'block';
                    currentImage.classList.remove('selected');
                    imageSelected = false;
                });
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        jsPsych.finishTrial();
                    });
                }
            }
        };
        // === END DRAG AND DROP TRAINING BLOCK ===

        // === DRAG AND DROP QUESTION BLOCK ===
        const dragAndDropQuestion = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <style>
                    .drag-container {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 20px;
                        padding: 20px;
                        max-width: 1200px;
                        margin: 0 auto;
                    }
                    
                    .question-text {
                        font-size: 1.5em;
                        font-weight: bold;
                        text-align: center;
                        color: #333;
                        margin-bottom: 20px;
                    }
                    
                    .current-image-container {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 15px;
                        margin-bottom: 30px;
                    }
                    
                    .current-image {
                        max-width: 300px;
                        max-height: 300px;
                        width: auto;
                        height: auto;
                        border-radius: 15px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .current-image:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
                    }
                    
                    .current-image.selected {
                        border: 5px solid #ffeb3b;
                        box-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
                        transform: scale(1.05);
                    }
                    
                    .current-image.dragging {
                        opacity: 0.5;
                        transform: scale(1.1);
                    }
                    
                    .drop-zones-container {
                        display: flex;
                        gap: 40px;
                        justify-content: center;
                        margin-bottom: 30px;
                    }
                    
                    .drop-zone {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 15px;
                    }
                    
                    .character-image {
                        max-width: 150px;
                        max-height: 150px;
                        width: auto;
                        height: auto;
                        border-radius: 10px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .drop-box {
                        width: 300px;
                        min-height: 200px;
                        border: 3px dashed #ccc;
                        border-radius: 15px;
                        background-color: #f9f9f9;
                        transition: all 0.3s ease;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                        padding: 15px;
                        align-items: flex-start;
                        justify-content: flex-start;
                        cursor: pointer;
                    }
                    
                    .drop-box.dragover {
                        border-color: #2ecc40;
                        background-color: #e8f5e8;
                    }
                    
                    .drop-box:hover {
                        border-color: #999;
                        background-color: #f5f5f5;
                    }
                    
                    .dropped-image {
                        max-width: 120px;
                        max-height: 120px;
                        width: auto;
                        height: auto;
                        border-radius: 8px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                        flex-shrink: 0;
                    }
                    
                    /* Hover effects for image choice options */
                    .option-image:hover {
                        transform: scale(1.1) !important;
                        box-shadow: 0 4px 16px rgba(0,0,0,0.2) !important;
                    }
                    
                    /* Hover effects for option containers */
                    .option-container:hover {
                        border-color: #2ecc40 !important;
                        background-color: #e8f5e8 !important;
                        transform: scale(1.02) !important;
                        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
                    }
                </style>
                
                <div class="drag-container">
                    <div class="current-image-container">
                        <img id="current-image" class="current-image" draggable="true" src="img/gG1.png${cacheBuster}" alt="Current Image">
                    </div>
                    
                    <div class="drop-zones-container">
                        <div class="drop-zone">
                            <img class="character-image" src="img/mippoSQ.png${cacheBuster}" alt="Mippo">
                            <div class="drop-box" id="mippo-box" data-correct="gG1,gG2,gB1,gB2">
                                <!-- Dropped images will appear here -->
                            </div>
                        </div>
                        
                        <div class="drop-zone">
                            <img class="character-image" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy">
                            <div class="drop-box" id="tuvvy-box" data-correct="oB1,oG1,oB2,gG2,gB2,oB2">
                                <!-- Dropped images will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const currentImage = document.getElementById('current-image');
                const mippoBox = document.getElementById('mippo-box');
                const tuvvyBox = document.getElementById('tuvvy-box');
                const nextBtn = document.getElementById('custom-next-btn');
                
                // Create audio elements dynamically with cacheBuster and preload for mobile
                const correctAudio = new Audio('mp3/correct.mp3' + cacheBuster);
                correctAudio.preload = 'auto';
                correctAudio.load();
                const incorrectAudio = new Audio('mp3/notDiff.mp3' + cacheBuster);
                incorrectAudio.preload = 'auto';
                incorrectAudio.load();
                
                // Function to play audio reliably on mobile
                function playAudio(audioElement) {
                    audioElement.currentTime = 0; // Reset to start
                    const playPromise = audioElement.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(e => console.log('Audio play error:', e));
                    }
                }
                
                // Hide default jsPsych button
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                // Image sequence
                const imageSequence = [
                    { src: 'gG1.png', correctBox: 'mippo' },
                    { src: 'oB1.png', correctBox: 'tuvvy' },
                    { src: 'gB1.png', correctBox: 'mippo' },
                    { src: 'oG1.png', correctBox: 'tuvvy' },
                    { src: 'oB2.png', correctBox: 'tuvvy' },
                    { src: 'gG2.png', correctBox: 'mippo' },
                    { src: 'gB2.png', correctBox: 'mippo' },
                    { src: 'oG2.png', correctBox: 'tuvvy' }
                ];
                
                let currentIndex = 0;
                let correctAnswers = 0;
                let userInteracted = false;
                
                function showNextImage() {
                    if (currentIndex < imageSequence.length) {
                        currentImage.src = `img/${imageSequence[currentIndex].src}${cacheBuster}`;
                        currentImage.alt = `Image ${currentIndex + 1}`;
                    } else {
                        // All images completed
                        currentImage.style.display = 'none';
                    }
                }
                
                // Tap-to-select, tap-to-place functionality (easier for tablets)
                let imageSelected = false;
                
                // Click/tap on image to select it
                currentImage.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    userInteracted = true;
                    if (currentImage.style.display !== 'none' && currentIndex < imageSequence.length) {
                        imageSelected = true;
                        this.classList.add('selected');
                    }
                });
                
                // Click/tap on drop boxes to place image
                [mippoBox, tuvvyBox].forEach(box => {
                    box.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        userInteracted = true;
                        
                        if (imageSelected && currentIndex < imageSequence.length) {
                            const droppedImageSrc = imageSequence[currentIndex].src;
                            const correctBox = imageSequence[currentIndex].correctBox;
                            const isCorrect = (correctBox === 'mippo' && this.id === 'mippo-box') || 
                                            (correctBox === 'tuvvy' && this.id === 'tuvvy-box');
                            
                            console.log(`Image: ${droppedImageSrc}, Correct box: ${correctBox}, Dropped in: ${this.id}, Is correct: ${isCorrect}`);
                            
                            if (isCorrect) {
                                // Correct answer
                                playAudio(correctAudio);
                                correctAnswers++;
                                
                                // Add image to the box
                                const droppedImg = document.createElement('img');
                                droppedImg.src = `img/${droppedImageSrc}${cacheBuster}`;
                                droppedImg.className = 'dropped-image';
                                droppedImg.alt = `Dropped ${droppedImageSrc}`;
                                this.appendChild(droppedImg);
                                
                                // Move to next image
                                currentImage.classList.remove('selected');
                                imageSelected = false;
                                currentIndex++;
                                setTimeout(() => {
                                    showNextImage();
                                }, 300);
                                
                            } else {
                                // Incorrect answer
                                playAudio(incorrectAudio);
                                currentImage.classList.remove('selected');
                                imageSelected = false;
                            }
                            
                            // Record the response
                            jsPsych.data.addProperties({
                                drag_drop_image: droppedImageSrc,
                                drag_drop_box: this.id,
                                drag_drop_correct: isCorrect,
                                drag_drop_trial: currentIndex + 1
                            });
                        }
                    });
                });
                
                // Keep drag functionality for desktop (mouse)
                currentImage.addEventListener('dragstart', function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', imageSequence[currentIndex].src);
                    userInteracted = true;
                });
                
                currentImage.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                // Drop zone functionality (mouse)
                [mippoBox, tuvvyBox].forEach(box => {
                    box.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.classList.add('dragover');
                    });
                    
                    box.addEventListener('dragleave', function() {
                        this.classList.remove('dragover');
                    });
                    
                    box.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('dragover');
                        
                        const droppedImageSrc = e.dataTransfer.getData('text/plain');
                        const correctBox = imageSequence[currentIndex].correctBox;
                        const isCorrect = (correctBox === 'mippo' && this.id === 'mippo-box') || 
                                        (correctBox === 'tuvvy' && this.id === 'tuvvy-box');
                        
                        console.log(`Image: ${droppedImageSrc}, Correct box: ${correctBox}, Dropped in: ${this.id}, Is correct: ${isCorrect}`);
                        
                        if (isCorrect) {
                            // Correct answer
                            playAudio(correctAudio);
                            correctAnswers++;
                            
                            // Add image to the box
                            const droppedImg = document.createElement('img');
                            droppedImg.src = `img/${droppedImageSrc}${cacheBuster}`;
                            droppedImg.className = 'dropped-image';
                            droppedImg.alt = `Dropped ${droppedImageSrc}`;
                            this.appendChild(droppedImg);
                            
                            // Move to next image
                            currentIndex++;
                            setTimeout(() => {
                                showNextImage();
                            }, 300);
                            
                        } else {
                            // Incorrect answer
                            playAudio(incorrectAudio);
                            
                            // Return image to original position after a short delay
                            setTimeout(() => {
                                // Image automatically returns to original position
                            }, 500);
                        }
                        
                        // Record the response
                        jsPsych.data.addProperties({
                            drag_drop_image: droppedImageSrc,
                            drag_drop_box: this.id,
                            drag_drop_correct: isCorrect,
                            drag_drop_trial: currentIndex + 1
                        });
                    });
                });
                

                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        userInteracted = true;
                        jsPsych.finishTrial();
                    });
                }
                
                // Ensure user interaction is detected
                document.addEventListener('click', function() {
                    userInteracted = true;
                }, { once: true });
                
                // Initialize
                showNextImage();
            }
        };
        // === END DRAG AND DROP QUESTION BLOCK ===

        // === GREENMIPPOINDSTREN BLOCK ===
        const greenMippoIndStren = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <style>
                    html, body { overflow: hidden !important; }
                    
                    @media (max-width: 768px) {
                        .top-section {
                            flex-direction: column !important;
                            gap: 20px !important;
                        }
                        
                        .bottom-section {
                            gap: 15px !important;
                            margin-bottom: 120px !important;
                        }
                        
                        .option-img {
                            max-width: 220px !important;
                            max-height: 180px !important;
                        }
                        
                        .top-img {
                            max-width: 300px !important;
                            max-height: 200px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .bottom-section {
                            gap: 12px !important;
                            margin-bottom: 100px !important;
                        }
                        
                        .option-img {
                            max-width: 180px !important;
                            max-height: 150px !important;
                        }
                        
                        .top-img {
                            max-width: 250px !important;
                            max-height: 180px !important;
                        }
                    }
                </style>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 80vh; width: 100vw; padding-top: 60px;">
                    <!-- Top Section -->
                    <div style="max-width: 1200px; margin: 0 auto; padding-bottom: 180px;">
                        <div class="top-section" style="display: flex; flex-direction: row; justify-content: center; align-items: center; width: 100%; margin-bottom: 0; flex-wrap: wrap;">
                            <img class="top-img" src="img/greenMippo.png${cacheBuster}" alt="Mippo" style="max-width: 400px; max-height: 320px; display: block; width: auto; height: auto; margin: 0 auto 32px auto;">
                        </div>
                        
                        <!-- Bottom Section -->
                        <div class="bottom-section" style="display: flex; flex-direction: row; justify-content: center; align-items: flex-end; gap: clamp(12px, 2.5vw, 25px); margin-bottom: 32px; flex-wrap: nowrap; width: 100%; max-width: 100vw; overflow-x: auto; text-align: center;">
                            <img id="jOneG-img" class="option-img" src="img/jOneG.png${cacheBuster}" alt="jOneG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="fewG-img" class="option-img" src="img/fewG.png${cacheBuster}" alt="fewG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="halfG-img" class="option-img" src="img/halfG.png${cacheBuster}" alt="halfG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="aLotG-img" class="option-img" src="img/aLotG.png${cacheBuster}" alt="aLotG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="allG-img" class="option-img" src="img/allG.png${cacheBuster}" alt="allG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const jOneGImg = document.getElementById('jOneG-img');
                const fewGImg = document.getElementById('fewG-img');
                const halfGImg = document.getElementById('halfG-img');
                const aLotGImg = document.getElementById('aLotG-img');
                const allGImg = document.getElementById('allG-img');
                const nextBtn = document.getElementById('custom-next-btn');
                
                // Hide default jsPsych button
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ greenMippoIndStren_choice: choice });
                    
                    // Reset all options to default state
                    [jOneGImg, fewGImg, halfGImg, aLotGImg, allGImg].forEach(img => {
                        if (img) {
                            img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.12)';
                            img.style.border = 'none';
                        }
                    });
                    
                    // Highlight the chosen option
                    const chosenImg = document.getElementById(selectedChoice + '-img');
                    if (chosenImg) {
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.border = '3px solid #ffe066';
                    }
                    
                    // Enable the Next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    // Don't auto-advance - let user control when to proceed
                    // The trial will advance when they click the Next button
                }
                
                // Add click handlers to all options
                [jOneGImg, fewGImg, halfGImg, aLotGImg, allGImg].forEach(img => {
                    if (img) {
                        img.addEventListener('click', function() {
                            const choiceName = this.id.replace('-img', '');
                            handleChoice(choiceName);
                        });
                    }
                });
                
                // Add click handler to Next button
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };
        // === END GREENMIPPOINDSTREN BLOCK ===

        // === ORANGETUVVYINDSTREN BLOCK ===
        const orangeTuvvyIndStren = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <style>
                    html, body { overflow: hidden !important; }
                    @media (max-width: 768px) {
                        .top-section {
                            flex-direction: column !important;
                            gap: 20px !important;
                        }
                        .bottom-section {
                            gap: 15px !important;
                            margin-bottom: 120px !important;
                        }
                        .option-img {
                            max-width: 220px !important;
                            max-height: 180px !important;
                        }
                        .top-img {
                            max-width: 300px !important;
                            max-height: 200px !important;
                        }
                    }
                    @media (max-width: 480px) {
                        .bottom-section {
                            gap: 12px !important;
                            margin-bottom: 100px !important;
                        }
                        .option-img {
                            max-width: 180px !important;
                            max-height: 150px !important;
                        }
                        .top-img {
                            max-width: 250px !important;
                            max-height: 180px !important;
                        }
                    }
                </style>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 80vh; width: 100vw; padding-top: 60px;">
                    <div style="max-width: 1200px; margin: 0 auto; padding-bottom: 180px;">
                        <div class="top-section" style="display: flex; flex-direction: row; justify-content: center; align-items: center; width: 100%; margin-bottom: 0; flex-wrap: wrap;">
                            <img class="top-img" src="img/orangeTuvvy.png${cacheBuster}" alt="Tuvvy" style="max-width: 400px; max-height: 320px; display: block; width: auto; height: auto; margin: 0 auto 32px auto;">
                        </div>
                        <div class="bottom-section" style="display: flex; flex-direction: row; justify-content: center; align-items: flex-end; gap: clamp(12px, 2.5vw, 25px); margin-bottom: 32px; flex-wrap: nowrap; width: 100%; max-width: 100vw; overflow-x: auto; text-align: center;">
                            <img id="jOneO-img" class="option-img" src="img/jOneO.png${cacheBuster}" alt="jOneO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="fewO-img" class="option-img" src="img/fewO.png${cacheBuster}" alt="fewO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="halfO-img" class="option-img" src="img/halfO.png${cacheBuster}" alt="halfO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="aLotO-img" class="option-img" src="img/aLotO.png${cacheBuster}" alt="aLotO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="allO-img" class="option-img" src="img/allO.png${cacheBuster}" alt="allO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const jOneOImg = document.getElementById('jOneO-img');
                const fewOImg = document.getElementById('fewO-img');
                const halfOImg = document.getElementById('halfO-img');
                const aLotOImg = document.getElementById('aLotO-img');
                const allOImg = document.getElementById('allO-img');
                const nextBtn = document.getElementById('custom-next-btn');
                
                // Hide default jsPsych button
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ orangeTuvvyIndStren_choice: choice });
                    
                    // Reset all options to default state
                    [jOneOImg, fewOImg, halfOImg, aLotOImg, allOImg].forEach(img => {
                        if (img) {
                            img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.12)';
                            img.style.border = 'none';
                        }
                    });
                    
                    // Highlight the chosen option
                    const chosenImg = document.getElementById(selectedChoice + '-img');
                    if (chosenImg) {
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.border = '3px solid #ffe066';
                    }
                    
                    // Enable the Next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    // Don't auto-advance - let user control when to proceed
                    // The trial will advance when they click the Next button
                }
                
                // Add click handlers to all options
                [jOneOImg, fewOImg, halfOImg, aLotOImg, allOImg].forEach(img => {
                    if (img) {
                        img.addEventListener('click', function() {
                            const choiceName = this.id.replace('-img', '');
                            handleChoice(choiceName);
                        });
                    }
                });
                
                // Add click handler to Next button
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };
        // === END ORANGETUVVYINDSTREN BLOCK ===

        // === GREENMIPPOINDSTREN REPEAT (AFTER FORCED CHOICE) ===
        const greenMippoIndStren_repeat = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <style>
                    html, body { overflow: hidden !important; }
                    
                    @media (max-width: 768px) {
                        .top-section {
                            flex-direction: column !important;
                            gap: 20px !important;
                        }
                        
                        .bottom-section {
                            gap: 15px !important;
                            margin-bottom: 120px !important;
                        }
                        
                        .option-img {
                            max-width: 220px !important;
                            max-height: 180px !important;
                        }
                        
                        .top-img {
                            max-width: 300px !important;
                            max-height: 200px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .bottom-section {
                            gap: 12px !important;
                            margin-bottom: 100px !important;
                        }
                        
                        .option-img {
                            max-width: 180px !important;
                            max-height: 150px !important;
                        }
                        
                        .top-img {
                            max-width: 250px !important;
                            max-height: 180px !important;
                        }
                    }
                </style>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 80vh; width: 100vw; padding-top: 60px;">
                    <!-- Top Section -->
                    <div style="max-width: 1200px; margin: 0 auto; padding-bottom: 180px;">
                        <div class="top-section" style="display: flex; flex-direction: row; justify-content: center; align-items: center; width: 100%; margin-bottom: 0; flex-wrap: wrap;">
                            <img class="top-img" src="img/greenMippo.png${cacheBuster}" alt="Mippo" style="max-width: 400px; max-height: 320px; display: block; width: auto; height: auto; margin: 0 auto 32px auto;">
                        </div>
                        
                        <!-- Bottom Section -->
                        <div class="bottom-section" style="display: flex; flex-direction: row; justify-content: center; align-items: flex-end; gap: clamp(12px, 2.5vw, 25px); margin-bottom: 32px; flex-wrap: nowrap; width: 100%; max-width: 100vw; overflow-x: auto; text-align: center;">
                            <img id="jOneG-img-repeat" class="option-img" src="img/jOneG.png${cacheBuster}" alt="jOneG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="fewG-img-repeat" class="option-img" src="img/fewG.png${cacheBuster}" alt="fewG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="halfG-img-repeat" class="option-img" src="img/halfG.png${cacheBuster}" alt="halfG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="aLotG-img-repeat" class="option-img" src="img/aLotG.png${cacheBuster}" alt="aLotG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="allG-img-repeat" class="option-img" src="img/allG.png${cacheBuster}" alt="allG" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-repeat-green" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const jOneGImg = document.getElementById('jOneG-img-repeat');
                const fewGImg = document.getElementById('fewG-img-repeat');
                const halfGImg = document.getElementById('halfG-img-repeat');
                const aLotGImg = document.getElementById('aLotG-img-repeat');
                const allGImg = document.getElementById('allG-img-repeat');
                const nextBtn = document.getElementById('custom-next-btn-repeat-green');
                
                // Hide default jsPsych button
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ greenMippoIndStren_choice_repeat: choice });
                    
                    // Reset all options to default state
                    [jOneGImg, fewGImg, halfGImg, aLotGImg, allGImg].forEach(img => {
                        if (img) {
                            img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.12)';
                            img.style.border = 'none';
                        }
                    });
                    
                    // Highlight the chosen option
                    const chosenImg = document.getElementById(selectedChoice + '-img-repeat');
                    if (chosenImg) {
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.border = '3px solid #ffe066';
                    }
                    
                    // Enable the Next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                }
                
                // Add click handlers to all options
                [jOneGImg, fewGImg, halfGImg, aLotGImg, allGImg].forEach(img => {
                    if (img) {
                        img.addEventListener('click', function() {
                            const choiceName = this.id.replace('-img-repeat', '');
                            handleChoice(choiceName);
                        });
                    }
                });
                
                // Add click handler to Next button
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };
        // === END GREENMIPPOINDSTREN REPEAT ===

        // === ORANGETUVVYINDSTREN REPEAT (AFTER FORCED CHOICE) ===
        const orangeTuvvyIndStren_repeat = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <style>
                    html, body { overflow: hidden !important; }
                    @media (max-width: 768px) {
                        .top-section {
                            flex-direction: column !important;
                            gap: 20px !important;
                        }
                        .bottom-section {
                            gap: 15px !important;
                            margin-bottom: 120px !important;
                        }
                        .option-img {
                            max-width: 220px !important;
                            max-height: 180px !important;
                        }
                        .top-img {
                            max-width: 300px !important;
                            max-height: 200px !important;
                        }
                    }
                    @media (max-width: 480px) {
                        .bottom-section {
                            gap: 12px !important;
                            margin-bottom: 100px !important;
                        }
                        .option-img {
                            max-width: 180px !important;
                            max-height: 150px !important;
                        }
                        .top-img {
                            max-width: 250px !important;
                            max-height: 180px !important;
                        }
                    }
                </style>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 80vh; width: 100vw; padding-top: 60px;">
                    <div style="max-width: 1200px; margin: 0 auto; padding-bottom: 180px;">
                        <div class="top-section" style="display: flex; flex-direction: row; justify-content: center; align-items: center; width: 100%; margin-bottom: 0; flex-wrap: wrap;">
                            <img class="top-img" src="img/orangeTuvvy.png${cacheBuster}" alt="Tuvvy" style="max-width: 400px; max-height: 320px; display: block; width: auto; height: auto; margin: 0 auto 32px auto;">
                        </div>
                        <div class="bottom-section" style="display: flex; flex-direction: row; justify-content: center; align-items: flex-end; gap: clamp(12px, 2.5vw, 25px); margin-bottom: 32px; flex-wrap: nowrap; width: 100%; max-width: 100vw; overflow-x: auto; text-align: center;">
                            <img id="jOneO-img-repeat" class="option-img" src="img/jOneO.png${cacheBuster}" alt="jOneO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="fewO-img-repeat" class="option-img" src="img/fewO.png${cacheBuster}" alt="fewO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="halfO-img-repeat" class="option-img" src="img/halfO.png${cacheBuster}" alt="halfO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="aLotO-img-repeat" class="option-img" src="img/aLotO.png${cacheBuster}" alt="aLotO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                            <img id="allO-img-repeat" class="option-img" src="img/allO.png${cacheBuster}" alt="allO" style="max-width: clamp(100px, 20vw, 250px); max-height: clamp(80px, 16vw, 200px); height: auto; cursor: pointer; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.12); margin: 12px 0;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-repeat-orange" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const jOneOImg = document.getElementById('jOneO-img-repeat');
                const fewOImg = document.getElementById('fewO-img-repeat');
                const halfOImg = document.getElementById('halfO-img-repeat');
                const aLotOImg = document.getElementById('aLotO-img-repeat');
                const allOImg = document.getElementById('allO-img-repeat');
                const nextBtn = document.getElementById('custom-next-btn-repeat-orange');
                
                // Hide default jsPsych button
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ orangeTuvvyIndStren_choice_repeat: choice });
                    
                    // Reset all options to default state
                    [jOneOImg, fewOImg, halfOImg, aLotOImg, allOImg].forEach(img => {
                        if (img) {
                            img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.12)';
                            img.style.border = 'none';
                        }
                    });
                    
                    // Highlight the chosen option
                    const chosenImg = document.getElementById(selectedChoice + '-img-repeat');
                    if (chosenImg) {
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.border = '3px solid #ffe066';
                    }
                    
                    // Enable the Next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                }
                
                // Add click handlers to all options
                [jOneOImg, fewOImg, halfOImg, aLotOImg, allOImg].forEach(img => {
                    if (img) {
                        img.addEventListener('click', function() {
                            const choiceName = this.id.replace('-img-repeat', '');
                            handleChoice(choiceName);
                        });
                    }
                });
                
                // Add click handler to Next button
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };
        // === END ORANGETUVVYINDSTREN REPEAT ===

        // === GREENMIPPO BLOCK ===
        const greenMippo = {
            timeline: [
                greenTeamLovesMippo,
                orangeTeamLovesTuvvy,
                guessingGameIntro,
                dragAndDropTraining,
                dragAndDropQuestion,
                greenMippoIndStren,
                orangeTuvvyIndStren
            ]
        };
        // === END GREENMIPPO BLOCK ===

        // timeline.push(greenMippo); // removed per reduced block list

    // === BEGIN SPOTTHEDIFFERENCE BLOCK ===
  // Preload trial
        const preload = {
            type: jsPsychHtmlButtonResponse,
            stimulus: 'Loading...',
            choices: [],
            trial_duration: 1000,
            on_load: function() {
                console.log('Preloading files...');
                
                // Add participant ID to data
                jsPsych.data.addProperties({
                    participant_id: participantID
                });
                
                // Preload images
                const images = [
                    'img/t2Left.png' + cacheBuster,
                    'img/t2Right.png' + cacheBuster,
                    'img/left.png' + cacheBuster,
                    'img/right.png' + cacheBuster,
                    'img/oneCounterLeftA.png' + cacheBuster,
                    'img/oneCounterRightA.png' + cacheBuster,
                    'img/oneCounterLeftB.png' + cacheBuster,
                    'img/oneCounterRightB.png' + cacheBuster,
                    'img/Diff3Left.png' + cacheBuster,
                    'img/Diff3Right.png' + cacheBuster,
                    'img/Diff4Left.png' + cacheBuster,
                    'img/Diff4Right.png' + cacheBuster,
                    'img/fingerStD.png' + cacheBuster,
                    'img/clap.png' + cacheBuster,
                    'img/twoPicture.png' + cacheBuster,
                    'img/onePicture.png' + cacheBuster,
                    'img/finger.png' + cacheBuster,
                    'img/a.png' + cacheBuster,
                    'img/b.png' + cacheBuster,
                    'img/c.png' + cacheBuster,
                    'img/d.png' + cacheBuster,
                    'img/e.png' + cacheBuster,
                    'img/f.png' + cacheBuster,
                    // Memory check images
                    'img/MoB1.png' + cacheBuster,
                    'img/MgG1.png' + cacheBuster,
                    'img/MgB1.png' + cacheBuster,
                    'img/MoG1.png' + cacheBuster,
                    'img/MoB2.png' + cacheBuster,
                    'img/MoG2.png' + cacheBuster,
                    'img/MgB2.png' + cacheBuster,
                    'img/MgG2.png' + cacheBuster,
                    'img/MoNB.png' + cacheBuster,
                    'img/MgGNon1.png' + cacheBuster,
                    'img/MgBNon1.png' + cacheBuster,
                    'img/MoBNon1.png' + cacheBuster
                ];
                
                images.forEach(src => {
                    const img = new Image();
                    img.onload = () => console.log('Image loaded:', src);
                    img.onerror = () => console.log('Image failed to load:', src);
                    img.src = src;
                });

                // Preload audio for feedback
                const correctAudio = new Audio('mp3/correct.mp3' + cacheBuster);
                correctAudio.oncanplay = () => console.log('Correct audio loaded');
                correctAudio.onerror = () => console.log('Correct audio failed to load');
                correctAudio.load();
                
                const gotItAlreadyAudio = new Audio('mp3/gotItAlready.mp3' + cacheBuster);
                gotItAlreadyAudio.oncanplay = () => console.log('GotItAlready audio loaded');
                gotItAlreadyAudio.onerror = () => console.log('GotItAlready audio failed to load');
                gotItAlreadyAudio.load();
                
                const notDiffAudio = new Audio('mp3/notDiff.mp3' + cacheBuster);
                notDiffAudio.oncanplay = () => console.log('NotDiff audio loaded');
                notDiffAudio.onerror = () => console.log('NotDiff audio failed to load');
                notDiffAudio.load();
                
                const notLeftAudio = new Audio('mp3/notLeft.mp3' + cacheBuster);
                notLeftAudio.oncanplay = () => console.log('NotLeft audio loaded');
                notLeftAudio.onerror = () => console.log('NotLeft audio failed to load');
                notLeftAudio.load();
            }
        };



        // Introduction StD A block
        const introductionStD_A = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `
                    <div class="instructions">
                        <div id="visual-content" style="text-align: center;">
                            <img src="img/clap.png${cacheBuster}" id="clap-intro" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                            <div style="display: inline-block; position: relative;">
                                <img src="img/onePicture.png${cacheBuster}" id="left-onePicture" style="max-width: 40%; height: auto; margin-right: 20px; display: none;">
                                <img src="img/onePicture.png${cacheBuster}" id="right-onePicture" style="max-width: 40%; height: auto; margin-left: 20px; display: none;">
                                <img src="img/finger.png${cacheBuster}" id="finger-intro" style="position: absolute; top: 50%; right: 0; transform: translateY(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%; display: none;">
                            </div>
                        </div>
                        <div id="next-button" style="position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; opacity: 0.5; pointer-events: none;">Next</div>
                    </div>
                `;
            },
            choices: [],
            trial_duration: null,
            on_load: function() {
                console.log('Introduction StD A loaded');
                
                // Make next button immediately clickable
                const nextButton = document.getElementById('next-button');
                if (nextButton) {
                    nextButton.style.opacity = '1';
                    nextButton.style.pointerEvents = 'auto';
                    nextButton.onclick = function() {
                        jsPsych.finishTrial();
                    };
                }
            }
        };



        // Holder block - shows holderA and holderB, then holderFinger
        const holder_block = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/holderA.png${cacheBuster}" class="comparison-image" alt="Holder A">
                        </div>
                        <div class="image-container">
                            <img src="img/holderB.png${cacheBuster}" id="holder-right-image" class="comparison-image" alt="Holder B">
                        </div>
                    </div>
                    <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
                `;
            },
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    let hasShownFinger = false;
                    
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        
                        if (!hasShownFinger) {
                            // First click: Replace holderB with holderFinger
                            const rightImage = document.getElementById('holder-right-image');
                            if (rightImage) {
                                rightImage.src = `img/holderFinger.png${cacheBuster}`;
                                rightImage.alt = 'Holder Finger';
                            }
                            
                            // Update button text and mark as shown
                            nextBtn.textContent = 'Next';
                            hasShownFinger = true;
                        } else {
                            // Second click: Advance to next trial
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };



        // Clap block - simple visual
        const clap_block = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/clap.png${cacheBuster}" alt="Clap" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };

        // Clap block after preTrain training - simple visual
        const clap_block_after_preTrain = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/clap.png${cacheBuster}" alt="Clap" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                </div>
                <button id="custom-next-btn-after-preTrain" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-after-preTrain');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) { 
                        e.stopPropagation(); 
                        jsPsych.finishTrial(); 
                    });
                }
            }
        };

        // First training spot-the-difference task (using preTrain images)
        const preTrain_training_task = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const imageWidth = 1742;
                const imageHeight = 1388;
                // Store the differences array globally for this trial so it can be accessed in on_load
                window.currentPreTrainDifferences = getFreshDifferencesTrainingFirst();
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/preTrainLeft.png${cacheBuster}" class="comparison-image" alt="Original">
                        </div>
                        <div class="image-container">
                            <div style="position: relative; display: inline-block;">
                                <img src="img/preTrainRight.png${cacheBuster}" class="comparison-image" alt="Modified">
                                <img src="img/fingerStD.png${cacheBuster}" style="position: absolute; top: -150px; left: 50%; transform: translateX(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%;">
                                ${window.currentPreTrainDifferences.map(diff => {
                                    const xOffset = (diff.size / 2) / imageWidth * 100;
                                    const yOffset = (diff.size / 2) / imageHeight * 100;
                                    return `
                                        <div class="hotspot" 
                                             id="hotspotPreTrain-${diff.id}"
                                             style="left: calc(${diff.x}% - ${xOffset}%); top: calc(${diff.y}% - ${yOffset}%); width: ${diff.size}px; height: ${diff.size}px;"
                                             data-id="${diff.id}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="timer" id="timerPreTrain" style="display: none;"></div>
                    <button id="preTrain-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
                `;
            },
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null, // No time limit - continue until all differences are found
            on_load: function() {
                // Initialize state
                jsPsych.data.addProperties({
                    found_differences_preTrain: [],
                    found_times_preTrain: [],
                    start_time_preTrain: Date.now()
                });

                // Use the same differences array that was created in the stimulus
                const localPreTrainDifferences = window.currentPreTrainDifferences;
                
                // Add click handlers to hotspots (they are now rendered in the stimulus)
                const hotspotsPreTrain = document.querySelectorAll('.hotspot');
                
                hotspotsPreTrain.forEach((hotspot, index) => {
                    hotspot.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const diffId = this.getAttribute('data-id');
                        handleHotspotClickPreTrain(diffId, this, localPreTrainDifferences);
                    });
                });
                
                // Add click handler to the div containing the right image and hotspots
                const rightImageContainerPreTrain = document.querySelector('.image-container:last-child div');
                if (rightImageContainerPreTrain) {
                    rightImageContainerPreTrain.addEventListener('click', function(e) {
                        let target = e.target;
                        while (target && target !== this) {
                            if (target.classList && target.classList.contains('hotspot')) {
                                return;
                            }
                            target = target.parentElement;
                        }
                        const notDiffAudioPreTrain = new Audio('mp3/notDiff.mp3' + cacheBuster);
                        notDiffAudioPreTrain.play().catch(e => {});
                    });
                }

                // Add click handler to the left image
                const leftImagePreTrain = document.querySelector('.image-container:first-child img');
                if (leftImagePreTrain) {
                    leftImagePreTrain.addEventListener('click', function() {
                        const rightWrapper = document.querySelector('.image-container:last-child div');
                        if (rightWrapper) {
                            rightWrapper.classList.add('right-highlight');
                            setTimeout(() => rightWrapper.classList.remove('right-highlight'), 500);
                        }
                    });
                }

                // No timer needed - trial continues until all differences are found
                
                // Add Next button click handler
                const nextBtn = document.getElementById('preTrain-next-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // Get current data to access found differences count
                        const currentData = jsPsych.data.get().values()[0];
                        const foundDifferences = currentData.found_differences_preTrain || [];
                        
                        // Add final data properties before ending trial
                        jsPsych.data.addProperties({
                            end_time_preTrain: Date.now(),
                            total_found_preTrain: foundDifferences.length
                        });
                        
                        jsPsych.finishTrial();
                    });
                }
            },
            on_finish: function() {
                if (window.preTrainTimer) {
                    clearInterval(window.preTrainTimer);
                    window.preTrainTimer = null;
                }
                
                try {
                    jsPsych.data.addProperties({
                        end_time_preTrain: Date.now(),
                        total_found_preTrain: jsPsych.data.get().values()[0].found_differences_preTrain ? jsPsych.data.get().values()[0].found_differences_preTrain.length : 0
                    });
                } catch (error) {
                    console.error('Error adding final preTrain properties:', error);
                }
            }
        };

        // Second training spot-the-difference task (using t2 images)
        const training_task = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const imageWidth = 1742;
                const imageHeight = 1388;
                // Store the differences array globally for this trial so it can be accessed in on_load
                window.currentTrainingDifferences = getFreshDifferencesTraining();
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/t2Left.png${cacheBuster}" class="comparison-image" alt="Original">
                        </div>
                        <div class="image-container">
                            <div style="position: relative; display: inline-block;">
                                <img src="img/t2Right.png${cacheBuster}" class="comparison-image" alt="Modified">
                                <img src="img/fingerStD.png${cacheBuster}" style="position: absolute; top: -150px; left: 50%; transform: translateX(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%;">
                                ${window.currentTrainingDifferences.map(diff => {
                                    const xOffset = (diff.size / 2) / imageWidth * 100;
                                    const yOffset = (diff.size / 2) / imageHeight * 100;
                                    return `
                                        <div class="hotspot" 
                                             id="hotspotTraining-${diff.id}"
                                             style="left: calc(${diff.x}% - ${xOffset}%); top: calc(${diff.y}% - ${yOffset}%); width: ${diff.size}px; height: ${diff.size}px;"
                                             data-id="${diff.id}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="timer" id="timerTraining">90</div>
                `;
            },
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null, // Use custom timer for both 90s limit and early completion - ensure full duration
            on_load: function() {
                // Initialize state
                jsPsych.data.addProperties({
                    found_differences_training: [],
                    found_times_training: [],
                    start_time_training: Date.now()
                });

                // Use the same differences array that was created in the stimulus
                const localTrainingDifferences = window.currentTrainingDifferences;
                
                // Add click handlers to hotspots (they are now rendered in the stimulus)
                const hotspotsTraining = document.querySelectorAll('.hotspot');
                
                hotspotsTraining.forEach((hotspot, index) => {
                    hotspot.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const diffId = this.getAttribute('data-id');
                        handleHotspotClickTraining(diffId, this, localTrainingDifferences);
                    });
                });
                
                // Add click handler to the div containing the right image and hotspots
                const rightImageContainerTraining = document.querySelector('.image-container:last-child div');
                if (rightImageContainerTraining) {
                    rightImageContainerTraining.addEventListener('click', function(e) {
                        let target = e.target;
                        while (target && target !== this) {
                            if (target.classList && target.classList.contains('hotspot')) {
                                return;
                            }
                            target = target.parentElement;
                        }
                        const notDiffAudioTraining = new Audio('mp3/notDiff.mp3' + cacheBuster);
                        notDiffAudioTraining.play().catch(e => {});
                    });
                }

                // Add click handler to the left image
                const leftImageTraining = document.querySelector('.image-container:first-child img');
                if (leftImageTraining) {
                    leftImageTraining.addEventListener('click', function() {
                        const rightWrapper = document.querySelector('.image-container:last-child div');
                        if (rightWrapper) {
                            rightWrapper.classList.add('right-highlight');
                            setTimeout(() => rightWrapper.classList.remove('right-highlight'), 500);
                        }
                    });
                }

                // Start timer
                startTimerTraining();
                
                // Function to safely end the trial (either early or when timer expires)
                window.safeFinishTrainingTrial = function() {
                    if (window.trainingTimer) {
                        clearInterval(window.trainingTimer);
                        window.trainingTimer = null;
                    }
                    jsPsych.finishTrial();
                };
                

            },
            on_finish: function() {
                if (window.trainingTimer) {
                    clearInterval(window.trainingTimer);
                    window.trainingTimer = null;
                }
                
                try {
                    jsPsych.data.addProperties({
                        end_time_training: Date.now(),
                        total_found_training: jsPsych.data.get().values()[0].found_differences_training ? jsPsych.data.get().values()[0].found_differences_training.length : 0
                    });
                    
                    // Check if any differences were found in training
                    const currentData = jsPsych.data.get().values()[0];
                    const foundDifferences = currentData.found_differences_training || [];
                    
                    if (foundDifferences.length === 0) {
                        // No differences found - skip to veryEndCelebration
                        console.log('No differences found in training - skipping to veryEndCelebration');
                        // Store this information for the timeline logic
                        jsPsych.data.addProperties({
                            skip_to_very_end: true
                        });
                    } else {
                        // Differences found - continue normally
                        console.log('Differences found in training - continuing normally');
                        jsPsych.data.addProperties({
                            skip_to_very_end: false
                        });
                    }
                } catch (error) {
                    console.error('Error adding final training properties:', error);
                }
            }
        };

        // Training completion screen (only shown if they found at least one difference)
        const training_completion = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `
                    <div class="instructions">
                        <div id="visual-content" style="position: relative; display: inline-block;">
                            <img src="img/clap.png${cacheBuster}" id="clap-image" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                            <img src="img/twoPicture.png${cacheBuster}" id="twoPicture-image" style="max-width: 800px; height: auto; margin: 20px auto; display: none;">
                            <img src="img/fingerStD.png${cacheBuster}" id="fingerStD-image" style="position: absolute; top: -60px; right: 150px; width: 60px; height: auto; z-index: 10; max-width: 15%; display: none;">
                        </div>
                        <div id="next-button" style="position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; opacity: 0.5; pointer-events: none;">Next</div>
                    </div>
                `;
            },
            choices: [],
            trial_duration: null,
            on_load: function() {
                console.log('Training completion screen loaded');
                
                // Make next button immediately clickable
                const nextButton = document.getElementById('next-button');
                if (nextButton) {
                    nextButton.style.opacity = '1';
                    nextButton.style.pointerEvents = 'auto';
                    nextButton.onclick = function() {
                        jsPsych.finishTrial();
                    };
                }
            }
        };



        // First spot-the-difference task

        // Trial A
        const spot_difference_task_A = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                console.log('Rendering trial A...');
                const imageWidthA = 1742;
                const imageHeightA = 1388;
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/oneCounterLeftA.png${cacheBuster}" class="comparison-image" alt="Original">
                        </div>
                        <div class="image-container">
                            <div style="position: relative; display: inline-block;">
                                <img src="img/oneCounterRightA.png${cacheBuster}" class="comparison-image" alt="Modified">
                                <img src="img/fingerStD.png${cacheBuster}" style="position: absolute; top: -150px; left: 50%; transform: translateX(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%;">
                                ${differencesA.map(diff => {
                                    const xOffsetA = (diff.size / 2) / imageWidthA * 100;
                                    const yOffsetA = (diff.size / 2) / imageHeightA * 100;
                                    return `
                                        <div class="hotspot ${diff.found ? 'found' : ''}" 
                                             id="hotspotA-${diff.id}"
                                             style="left: calc(${diff.x}% - ${xOffsetA}%); top: calc(${diff.y}% - ${yOffsetA}%); width: ${diff.size}px; height: ${diff.size}px;"
                                             data-id="${diff.id}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="timer" id="timerA">90</div>
                `;
            },
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null, // Use custom timer for both 90s limit and early completion
            on_load: function() {
                console.log('Trial A loaded - setting up click handlers...');
                jsPsych.data.addProperties({
                    found_differences_A: [],
                    found_times_A: [],
                    start_time_A: Date.now()
                });
                const hotspotsA = document.querySelectorAll('.hotspot');
                console.log('Found', hotspotsA.length, 'hotspots in trial A');
                hotspotsA.forEach((hotspot, index) => {
                    hotspot.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const diffId = this.getAttribute('data-id');
                        handleHotspotClickA(diffId, this);
                    });
                });
                const rightImageContainerA = document.querySelector('.image-container:last-child div');
                if (rightImageContainerA) {
                    rightImageContainerA.addEventListener('click', function(e) {
                        let target = e.target;
                        while (target && target !== this) {
                            if (target.classList && target.classList.contains('hotspot')) {
                                return;
                            }
                            target = target.parentElement;
                        }
                        const notDiffAudioA = new Audio('mp3/notDiff.mp3' + cacheBuster);
                        notDiffAudioA.play().catch(e => {});
                    });
                }

                // Add click handler to the left image
                const leftImageA = document.querySelector('.image-container:first-child img');
                if (leftImageA) {
                    leftImageA.addEventListener('click', function() {
                        const rightWrapper = document.querySelector('.image-container:last-child div');
                        if (rightWrapper) {
                            rightWrapper.classList.add('right-highlight');
                            setTimeout(() => rightWrapper.classList.remove('right-highlight'), 500);
                        }
                    });
                }
                startTimerA();
            },
            on_finish: function() {
                console.log('Trial A finished - recording final data');
                // Clear timer
                if (window.trialATimer) {
                    clearInterval(window.trialATimer);
                    window.trialATimer = null;
                }
                jsPsych.data.addProperties({
                    end_time_A: Date.now(),
                    total_found_A: jsPsych.data.get().values()[0].found_differences_A.length
                });
            }
        };

        const trialA_completion = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `
                    <div class="instructions">
                        <div id="visual-content" style="position: relative; display: inline-block;">
                            <img src="img/clap.png${cacheBuster}" id="clap-image" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                            <img src="img/twoPicture.png${cacheBuster}" id="twoPicture-image" style="max-width: 800px; height: auto; margin: 20px auto; display: none;">
                            <img src="img/fingerStD.png${cacheBuster}" id="fingerStD-image" style="position: absolute; top: -60px; right: 150px; width: 60px; height: auto; z-index: 10; max-width: 15%; display: none;">
                        </div>
                        <div id="next-button" style="position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; opacity: 0.5; pointer-events: none;">Next</div>
                    </div>
                `;
            },
            choices: [],
            trial_duration: null,
            on_load: function() {
                console.log('Trial A completion screen loaded');
                
                // After 3 seconds, switch from clap to twoPicture
                setTimeout(() => {
                    const clapImage = document.getElementById('clap-image');
                    const twoPictureImage = document.getElementById('twoPicture-image');
                    if (clapImage && twoPictureImage) {
                        clapImage.style.display = 'none';
                        twoPictureImage.style.display = 'block';
                    }
                }, 3000);
                
                // After 12.5 seconds, show fingerStD
                setTimeout(() => {
                    const fingerStDImage = document.getElementById('fingerStD-image');
                    if (fingerStDImage) {
                        fingerStDImage.style.display = 'block';
                    }
                }, 12500);
                
                // After audio finishes (approximately 15 seconds), make next button clickable
                setTimeout(() => {
                    const nextButton = document.getElementById('next-button');
                    if (nextButton) {
                        nextButton.style.opacity = '1';
                        nextButton.style.pointerEvents = 'auto';
                        nextButton.onclick = function() {
                            jsPsych.finishTrial();
                        };
                    }
                }, 15000);
            }
        };

        // Trial B
        const spot_difference_task_B = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                console.log('Rendering trial B...');
                const imageWidthB = 1742;
                const imageHeightB = 1388;
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/oneCounterLeftB.png${cacheBuster}" class="comparison-image" alt="Original">
                        </div>
                        <div class="image-container">
                            <div style="position: relative; display: inline-block;">
                                <img src="img/oneCounterRightB.png${cacheBuster}" class="comparison-image" alt="Modified">
                                <img src="img/fingerStD.png${cacheBuster}" style="position: absolute; top: -150px; left: 50%; transform: translateX(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%;">
                                ${differencesB.map(diff => {
                                    const xOffsetB = (diff.size / 2) / imageWidthB * 100;
                                    const yOffsetB = (diff.size / 2) / imageHeightB * 100;
                                    return `
                                        <div class="hotspot ${diff.found ? 'found' : ''}" 
                                             id="hotspotB-${diff.id}"
                                             style="left: calc(${diff.x}% - ${xOffsetB}%); top: calc(${diff.y}% - ${yOffsetB}%); width: ${diff.size}px; height: ${diff.size}px;"
                                             data-id="${diff.id}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="timer" id="timerB">90</div>
                `;
            },
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null, // Use custom timer for both 90s limit and early completion
            on_load: function() {
                console.log('Trial B loaded - setting up click handlers...');
                jsPsych.data.addProperties({
                    found_differences_B: [],
                    found_times_B: [],
                    start_time_B: Date.now()
                });
                const hotspotsB = document.querySelectorAll('.hotspot');
                console.log('Found', hotspotsB.length, 'hotspots in trial B');
                hotspotsB.forEach((hotspot, index) => {
                    hotspot.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const diffId = this.getAttribute('data-id');
                        handleHotspotClickB(diffId, this);
                    });
                });
                const rightImageContainerB = document.querySelector('.image-container:last-child div');
                if (rightImageContainerB) {
                    rightImageContainerB.addEventListener('click', function(e) {
                        let target = e.target;
                        while (target && target !== this) {
                            if (target.classList && target.classList.contains('hotspot')) {
                                return;
                            }
                            target = target.parentElement;
                        }
                        const notDiffAudioB = new Audio('mp3/notDiff.mp3' + cacheBuster);
                        notDiffAudioB.play().catch(e => {});
                    });
                }

                // Add click handler to the left image
                const leftImageB = document.querySelector('.image-container:first-child img');
                if (leftImageB) {
                    leftImageB.addEventListener('click', function() {
                        const rightWrapper = document.querySelector('.image-container:last-child div');
                        if (rightWrapper) {
                            rightWrapper.classList.add('right-highlight');
                            setTimeout(() => rightWrapper.classList.remove('right-highlight'), 500);
                        }
                    });
                }
                startTimerB();
            },
            on_finish: function() {
                console.log('Trial B finished - recording final data');
                // Clear timer
                if (window.trialBTimer) {
                    clearInterval(window.trialBTimer);
                    window.trialBTimer = null;
                }
                jsPsych.data.addProperties({
                    end_time_B: Date.now(),
                    total_found_B: jsPsych.data.get().values()[0].found_differences_B.length
                });
            }
        };

        // Trial 3
        const spot_difference_task_3 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                console.log('Rendering trial 3...');
                const imageWidth = 1742;
                const imageHeight = 1388;
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/Diff3Left.png${cacheBuster}" class="comparison-image" alt="Original">
                        </div>
                        <div class="image-container">
                            <div style="position: relative; display: inline-block;">
                                <img src="img/Diff3Right.png${cacheBuster}" class="comparison-image" alt="Modified">
                                <img src="img/fingerStD.png${cacheBuster}" style="position: absolute; top: -150px; left: 50%; transform: translateX(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%;">
                                ${differences3.map(diff => {
                                    const xOffset = (diff.size / 2) / imageWidth * 100;
                                    const yOffset = (diff.size / 2) / imageHeight * 100;
                                    return `
                                        <div class="hotspot ${diff.found ? 'found' : ''}" 
                                             id="hotspot3-${diff.id}"
                                             style="left: calc(${diff.x}% - ${xOffset}%); top: calc(${diff.y}% - ${yOffset}%); width: ${diff.size}px; height: ${diff.size}px;"
                                             data-id="${diff.id}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="timer" id="timer3">90</div>
                `;
            },
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null,
            on_load: function() {
                console.log('Trial 3 loaded - setting up click handlers...');
                jsPsych.data.addProperties({
                    found_differences_3: [],
                    found_times_3: [],
                    start_time_3: Date.now()
                });
                const hotspots = document.querySelectorAll('.hotspot');
                hotspots.forEach(hs => {
                    hs.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const diffId = this.getAttribute('data-id');
                        handleHotspotClick3(diffId, this);
                    });
                });
                const rightImageContainer = document.querySelector('.image-container:last-child div');
                if (rightImageContainer) {
                    rightImageContainer.addEventListener('click', function(e) {
                        let target = e.target;
                        while (target && target !== this) {
                            if (target.classList && target.classList.contains('hotspot')) return;
                            target = target.parentElement;
                        }
                        new Audio('mp3/notDiff.mp3' + cacheBuster).play().catch(() => {});
                    });
                }
                const leftImage = document.querySelector('.image-container:first-child img');
                if (leftImage) {
                    leftImage.addEventListener('click', function() {
                        const rightWrapper = document.querySelector('.image-container:last-child div');
                        if (rightWrapper) {
                            rightWrapper.classList.add('right-highlight');
                            setTimeout(() => rightWrapper.classList.remove('right-highlight'), 500);
                        }
                    });
                }
                startTimer3();
            },
            on_finish: function() {
                if (window.trial3Timer) {
                    clearInterval(window.trial3Timer);
                    window.trial3Timer = null;
                }
                const currentData = jsPsych.data.get().values()[0];
                const found = currentData.found_differences_3 || [];
                jsPsych.data.addProperties({
                    end_time_3: Date.now(),
                    total_found_3: found.length
                });
            }
        };

        // Trial 4
        const spot_difference_task_4 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                console.log('Rendering trial 4...');
                const imageWidth = 1742;
                const imageHeight = 1388;
                return `
                    <div class="image-comparison">
                        <div class="image-container">
                            <img src="img/Diff4Left.png${cacheBuster}" class="comparison-image" alt="Original">
                        </div>
                        <div class="image-container">
                            <div style="position: relative; display: inline-block;">
                                <img src="img/Diff4Right.png${cacheBuster}" class="comparison-image" alt="Modified">
                                <img src="img/fingerStD.png${cacheBuster}" style="position: absolute; top: -150px; left: 50%; transform: translateX(-50%); width: 60px; height: auto; z-index: 10; max-width: 15%;">
                                ${differences4.map(diff => {
                                    const xOffset = (diff.size / 2) / imageWidth * 100;
                                    const yOffset = (diff.size / 2) / imageHeight * 100;
                                    return `
                                        <div class="hotspot ${diff.found ? 'found' : ''}" 
                                             id="hotspot4-${diff.id}"
                                             style="left: calc(${diff.x}% - ${xOffset}%); top: calc(${diff.y}% - ${yOffset}%); width: ${diff.size}px; height: ${diff.size}px;"
                                             data-id="${diff.id}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="timer" id="timer4">90</div>
                `;
            },
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null,
            on_load: function() {
                console.log('Trial 4 loaded - setting up click handlers...');
                jsPsych.data.addProperties({
                    found_differences_4new: [],
                    found_times_4new: [],
                    start_time_4new: Date.now()
                });
                const hotspots = document.querySelectorAll('.hotspot');
                hotspots.forEach(hs => {
                    hs.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const diffId = this.getAttribute('data-id');
                        handleHotspotClick4(diffId, this);
                    });
                });
                const rightImageContainer = document.querySelector('.image-container:last-child div');
                if (rightImageContainer) {
                    rightImageContainer.addEventListener('click', function(e) {
                        let target = e.target;
                        while (target && target !== this) {
                            if (target.classList && target.classList.contains('hotspot')) return;
                            target = target.parentElement;
                        }
                        new Audio('mp3/notDiff.mp3' + cacheBuster).play().catch(() => {});
                    });
                }
                const leftImage = document.querySelector('.image-container:first-child img');
                if (leftImage) {
                    leftImage.addEventListener('click', function() {
                        const rightWrapper = document.querySelector('.image-container:last-child div');
                        if (rightWrapper) {
                            rightWrapper.classList.add('right-highlight');
                            setTimeout(() => rightWrapper.classList.remove('right-highlight'), 500);
                        }
                    });
                }
                startTimer4();
            },
            on_finish: function() {
                if (window.trial4Timer) {
                    clearInterval(window.trial4Timer);
                    window.trial4Timer = null;
                }
                const currentData = jsPsych.data.get().values()[0];
                const found = currentData.found_differences_4new || [];
                jsPsych.data.addProperties({
                    end_time_4new: Date.now(),
                    total_found_4new: found.length
                });
            }
        };

        const trialB_completion = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                return `
                    <div class="instructions">
                        <div id="visual-content" style="position: relative; display: inline-block;">
                            <img src="img/clap.png${cacheBuster}" id="clap-image" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                            <img src="img/twoPicture.png${cacheBuster}" id="twoPicture-image" style="max-width: 800px; height: auto; margin: 20px auto; display: none;">
                            <img src="img/fingerStD.png${cacheBuster}" id="fingerStD-image" style="position: absolute; top: -60px; right: 150px; width: 60px; height: auto; z-index: 10; max-width: 15%; display: none;">
                        </div>
                        <div id="next-button" style="position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; opacity: 0.5; pointer-events: none;">Next</div>
                    </div>
                `;
            },
            choices: [],
            trial_duration: null,
            on_load: function() {
                console.log('Trial B completion screen loaded');
                
                // After 3 seconds, switch from clap to twoPicture
                setTimeout(() => {
                    const clapImage = document.getElementById('clap-image');
                    const twoPictureImage = document.getElementById('twoPicture-image');
                    if (clapImage && twoPictureImage) {
                        clapImage.style.display = 'none';
                        twoPictureImage.style.display = 'block';
                    }
                }, 3000);
                
                // After 12.5 seconds, show fingerStD
                setTimeout(() => {
                    const fingerStDImage = document.getElementById('fingerStD-image');
                    if (fingerStDImage) {
                        fingerStDImage.style.display = 'block';
                    }
                }, 12500);
                
                // After audio finishes (approximately 15 seconds), make next button clickable
                setTimeout(() => {
                    const nextButton = document.getElementById('next-button');
                    if (nextButton) {
                        nextButton.style.opacity = '1';
                        nextButton.style.pointerEvents = 'auto';
                        nextButton.onclick = function() {
                            jsPsych.finishTrial();
                        };
                    }
                }, 15000);
            }
        };

        // Create randomized middle trials - randomize the order of trial pairs
        const trial_pair_A = {
            timeline: [spot_difference_task_A, clap_block]
        };
        
        const trial_pair_B = {
            timeline: [spot_difference_task_B, clap_block]
        };
        
        const trial_pair_3 = {
            timeline: [spot_difference_task_3, clap_block]
        };
        
        const trial_pair_4 = {
            timeline: [spot_difference_task_4, clap_block]
        };
        
        // Create randomized middle trials with proper counterbalancing
        const randomized_middle_trials = {
            timeline: jsPsych.randomization.shuffle([trial_pair_A, trial_pair_B, trial_pair_3, trial_pair_4]),
            on_load: function() {
                console.log('Randomized middle trials loaded - order has been counterbalanced');
            }
        };


        // Clap celebration screen
        const clap_celebration = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions">
                    <img src="img/clap.png${cacheBuster}" style="max-width: 300px; height: auto; margin: 20px auto; display: block;">
                </div>
                <button id="clap-celebration-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['hidden'],
            button_html: '<button class="jspsych-html-button-response-button" style="display: none;">hidden</button>',
            trial_duration: null, // No time limit - wait for Next button click
            on_load: function() {
                console.log('Clap celebration screen loaded');
                
                // Add Next button click handler
                const nextBtn = document.getElementById('clap-celebration-next-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        jsPsych.finishTrial();
                    });
                }
            }
        };

        // Preparation screen for image choice question
        const image_choice_preparation = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Question mark placeholder -->
                    <div style="margin-bottom: 40px;">
                        <div style="display: flex; align-items: center; justify-content: center; width: 400px; height: 300px; margin: 0 auto; background-color: #f0f0f0; border-radius: 10px; border: 3px dashed #ccc;">
                            <span style="font-size: 120px; color: #999; font-weight: bold;">?</span>
                        </div>
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1);">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1);">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        jsPsych.finishTrial();
                    });
                }
            }
        };

        // Memory check training/preparation screen
        const memory_check_preparation = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Question mark placeholder -->
                    <div style="margin-bottom: 40px;">
                        <div style="display: flex; align-items: center; justify-content: center; width: 400px; height: 300px; margin: 0 auto; background-color: #f0f0f0; border-radius: 10px; border: 3px dashed #ccc;">
                            <span style="font-size: 120px; color: #999; font-weight: bold;">?</span>
                        </div>
                    </div>
                    
                    <!-- Two thumbs options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; padding: 40px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa;">
                            <div style="font-size: 120px; line-height: 1;"></div>
                        </div>
                        
                        <div class="option-container" style="text-align: center; padding: 40px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa;">
                            <div style="font-size: 120px; line-height: 1;"></div>
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-mem-training" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-mem-training');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        jsPsych.finishTrial();
                    });
                }
            }
        };

        // Image choice question section
        // Memory check question 1
        const memory_check_question_1 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MoB1.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two thumbs options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" id="thumbs-up-option-1" style="text-align: center; cursor: pointer; padding: 40px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <div style="font-size: 120px; line-height: 1;"></div>
                        </div>
                        
                        <div class="option-container" id="thumbs-down-option-1" style="text-align: center; cursor: pointer; padding: 40px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <div style="font-size: 120px; line-height: 1;"></div>
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-mem-1" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-mem-1');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const thumbsUpOption = document.getElementById('thumbs-up-option-1');
                const thumbsDownOption = document.getElementById('thumbs-down-option-1');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ 
                        memory_check_1: choice,
                        memory_check_1_image: 'MoB1'
                    });
                    
                    // Reset all option containers
                    [thumbsUpOption, thumbsDownOption].forEach(option => {
                        if (option) {
                            option.style.border = '3px solid #e0e0e0';
                            option.style.backgroundColor = '#f8f9fa';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight chosen option
                    const chosenOption = selectedChoice === 'remember' ? thumbsUpOption : thumbsDownOption;
                    if (chosenOption) {
                        chosenOption.style.border = '3px solid #ffe066';
                        chosenOption.style.backgroundColor = '#fff3cd';
                        chosenOption.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                }
                
                // Add click handlers
                if (thumbsUpOption) {
                    thumbsUpOption.addEventListener('click', function() {
                        handleChoice('remember');
                    });
                }
                
                if (thumbsDownOption) {
                    thumbsDownOption.addEventListener('click', function() {
                        handleChoice('not_remember');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };

        const image_choice_question = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MoB1.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option');
                const tuvvyOption = document.getElementById('tuvvy-option');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice selected: ${choice}`);
                }
                
                // Add click handlers to both options
                console.log('DEBUG: Setting up click handlers for original question');
                console.log('DEBUG: mippoOption element:', mippoOption);
                console.log('DEBUG: tuvvyOption element:', tuvvyOption);
                
                if (mippoOption) {
                    console.log('DEBUG: Adding click handler to mippo option');
                    mippoOption.addEventListener('click', function() {
                        console.log('DEBUG: Mippo option clicked!');
                        handleChoice('mippo');
                    });
                } else {
                    console.error('DEBUG: mippoOption not found!');
                }
                
                if (tuvvyOption) {
                    console.log('DEBUG: Adding click handler to tuvvy option');
                    tuvvyOption.addEventListener('click', function() {
                        console.log('DEBUG: Tuvvy option clicked!');
                        handleChoice('tuvvy');
                    });
                } else {
                    console.error('DEBUG: tuvvyOption not found!');
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };

        // Additional image choice questions with different middle images
        const image_choice_question_2 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MgG1.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-2" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-2" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-2" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-2');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-2');
                const tuvvyOption = document.getElementById('tuvvy-option-2');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_2: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-2');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 2 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                if (mippoOption) {
                    mippoOption.addEventListener('click', function() {
                        handleChoice('mippo');
                    });
                }
                
                if (tuvvyOption) {
                    tuvvyOption.addEventListener('click', function() {
                        handleChoice('tuvvy');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };

        const image_choice_question_3 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MgB1.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-3" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-3" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-3" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-3');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-3');
                const tuvvyOption = document.getElementById('tuvvy-option-3');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_3: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-3');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 3 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                if (mippoOption) {
                    mippoOption.addEventListener('click', function() {
                        handleChoice('mippo');
                    });
                }
                
                if (tuvvyOption) {
                    tuvvyOption.addEventListener('click', function() {
                        handleChoice('tuvvy');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };

        const image_choice_question_4 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MoG1.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-4" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-4" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-4" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-4');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-4');
                const tuvvyOption = document.getElementById('tuvvy-option-4');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_4: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-4');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 4 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                console.log('DEBUG: Setting up click handlers for MoG1 question (question 4)');
                console.log('DEBUG: mippoOption element:', mippoOption);
                console.log('DEBUG: tuvvyOption element:', tuvvyOption);
                
                if (mippoOption) {
                    console.log('DEBUG: Adding click handler to mippo option 4');
                    mippoOption.addEventListener('click', function() {
                        console.log('DEBUG: Mippo option 4 clicked!');
                        handleChoice('mippo');
                    });
                } else {
                    console.error('DEBUG: mippoOption 4 not found!');
                }
                
                if (tuvvyOption) {
                    console.log('DEBUG: Adding click handler to tuvvy option 4');
                    tuvvyOption.addEventListener('click', function() {
                        console.log('DEBUG: Tuvvy option 4 clicked!');
                        handleChoice('tuvvy');
                    });
                } else {
                    console.error('DEBUG: tuvvyOption 4 not found!');
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };


        const image_choice_question_6 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MoG2.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-6" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-6" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-6" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-6');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-6');
                const tuvvyOption = document.getElementById('tuvvy-option-6');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_6: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-6');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 6 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                if (mippoOption) {
                    mippoOption.addEventListener('click', function() {
                        handleChoice('mippo');
                    });
                }
                
                if (tuvvyOption) {
                    tuvvyOption.addEventListener('click', function() {
                        handleChoice('tuvvy');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };


        const image_choice_question_8 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MgG2.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-8" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-8" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-8" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-8');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-8');
                const tuvvyOption = document.getElementById('tuvvy-option-8');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_8: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-8');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 8 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                if (mippoOption) {
                    mippoOption.addEventListener('click', function() {
                        handleChoice('mippo');
                    });
                }
                
                if (tuvvyOption) {
                    tuvvyOption.addEventListener('click', function() {
                        handleChoice('tuvvy');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                    }
                }
            };

        const image_choice_question_5 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MoB2.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-5" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-5" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-5" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-5');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-5');
                const tuvvyOption = document.getElementById('tuvvy-option-5');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_5: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-5');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 5 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                if (mippoOption) {
                    mippoOption.addEventListener('click', function() {
                        handleChoice('mippo');
                    });
                }
                
                if (tuvvyOption) {
                    tuvvyOption.addEventListener('click', function() {
                        handleChoice('tuvvy');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };

        const image_choice_question_7 = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 800px; text-align: center;">
                    <!-- Top image -->
                    <div style="margin-bottom: 40px;">
                        <img src="img/MgB2.png${cacheBuster}" alt="Question Image" 
                             style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                    
                    <!-- Two options below -->
                    <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="mippo-option-7" src="img/mippoSQ.png${cacheBuster}" alt="Mippo" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                        
                        <div class="option-container" style="text-align: center; cursor: pointer; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                            <img id="tuvvy-option-7" src="img/tuvvySQ.png${cacheBuster}" alt="Tuvvy" 
                                 class="option-image" 
                                 style="max-width: 200px; max-height: 150px; width: auto; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; transform: scale(1); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; pointer-events: auto;">
                        </div>
                    </div>
                </div>
                <button id="custom-next-btn-7" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-7');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const mippoOption = document.getElementById('mippo-option-7');
                const tuvvyOption = document.getElementById('tuvvy-option-7');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                let choice = null;
                
                function handleChoice(selectedChoice) {
                    // Allow changing choice
                    choice = selectedChoice;
                    jsPsych.data.addProperties({ image_choice_question_7: choice });
                    
                    // Reset all option containers to default state
                    const allOptionContainers = document.querySelectorAll('.option-container');
                    allOptionContainers.forEach(container => {
                        container.style.border = '3px solid #e0e0e0';
                        container.style.backgroundColor = '#f8f9fa';
                        container.style.transform = 'scale(1)';
                    });
                    
                    // Reset all images to default state
                    [mippoOption, tuvvyOption].forEach(option => {
                        if (option) {
                            option.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                            option.style.transform = 'scale(1)';
                        }
                    });
                    
                    // Highlight the chosen option container and image
                    const chosenImg = document.getElementById(selectedChoice + '-option-7');
                    const chosenContainer = chosenImg ? chosenImg.closest('.option-container') : null;
                    
                    if (chosenImg && chosenContainer) {
                        // Highlight the container
                        chosenContainer.style.border = '3px solid #ffe066';
                        chosenContainer.style.backgroundColor = '#fff3cd';
                        chosenContainer.style.transform = 'scale(1.05)';
                        
                        // Highlight the image
                        chosenImg.style.boxShadow = '0 0 20px #ffe066, 0 0 30px #ffe066';
                        chosenImg.style.transform = 'scale(1.05)';
                    }
                    
                    // Enable next button
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                    
                    console.log(`Image choice 7 selected: ${choice}`);
                }
                
                // Add click handlers to both options
                if (mippoOption) {
                    mippoOption.addEventListener('click', function() {
                        handleChoice('mippo');
                    });
                }
                
                if (tuvvyOption) {
                    tuvvyOption.addEventListener('click', function() {
                        handleChoice('tuvvy');
                    });
                }
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (choice) {
                            jsPsych.finishTrial();
                        }
                    });
                }
            }
        };

        // Helper function to create memory check question
        function createMemoryCheck(questionNumber, imageSrc) {
            return {
                type: jsPsychHtmlButtonResponse,
                stimulus: `
                    <div class="instructions" style="max-width: 800px; text-align: center;">
                        <!-- Top image -->
                        <div style="margin-bottom: 40px;">
                            <img src="img/${imageSrc}${cacheBuster}" alt="Question Image" 
                                 style="max-width: 400px; max-height: 300px; width: auto; height: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        </div>
                        
                        <!-- Two thumbs options below -->
                        <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                            <div class="option-container" id="thumbs-up-option-${questionNumber}" style="text-align: center; cursor: pointer; padding: 40px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                                <div style="font-size: 120px; line-height: 1;"></div>
                            </div>
                            
                            <div class="option-container" id="thumbs-down-option-${questionNumber}" style="text-align: center; cursor: pointer; padding: 40px; border: 3px solid #e0e0e0; border-radius: 15px; background-color: #f8f9fa; transition: all 0.3s ease;">
                                <div style="font-size: 120px; line-height: 1;"></div>
                            </div>
                        </div>
                    </div>
                    <button id="custom-next-btn-mem-${questionNumber}" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20; opacity: 0.5; pointer-events: none;">Next</button>
                `,
                choices: ['Next'],
                on_load: function() {
                    const nextBtn = document.getElementById('custom-next-btn-mem-' + questionNumber);
                    const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                    const thumbsUpOption = document.getElementById('thumbs-up-option-' + questionNumber);
                    const thumbsDownOption = document.getElementById('thumbs-down-option-' + questionNumber);
                    
                    // Hide default jsPsych button
                    if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                    
                    let choice = null;
                    
                    function handleChoice(selectedChoice) {
                        choice = selectedChoice;
                        const dataProperty = {};
                        dataProperty['memory_check_' + questionNumber] = choice;
                        // Store the image name for this memory check
                        const imageName = imageSrc.replace('.png', '');
                        dataProperty['memory_check_' + questionNumber + '_image'] = imageName;
                        jsPsych.data.addProperties(dataProperty);
                        
                        // Reset all option containers
                        [thumbsUpOption, thumbsDownOption].forEach(option => {
                            if (option) {
                                option.style.border = '3px solid #e0e0e0';
                                option.style.backgroundColor = '#f8f9fa';
                                option.style.transform = 'scale(1)';
                            }
                        });
                        
                        // Highlight chosen option
                        const chosenOption = selectedChoice === 'remember' ? thumbsUpOption : thumbsDownOption;
                        if (chosenOption) {
                            chosenOption.style.border = '3px solid #ffe066';
                            chosenOption.style.backgroundColor = '#fff3cd';
                            chosenOption.style.transform = 'scale(1.05)';
                        }
                        
                        // Enable next button
                        if (nextBtn) {
                            nextBtn.style.opacity = '1';
                            nextBtn.style.pointerEvents = 'auto';
                        }
                    }
                    
                    // Add click handlers
                    if (thumbsUpOption) {
                        thumbsUpOption.addEventListener('click', function() {
                            handleChoice('remember');
                        });
                    }
                    
                    if (thumbsDownOption) {
                        thumbsDownOption.addEventListener('click', function() {
                            handleChoice('not_remember');
                        });
                    }
                    
                    // Next button functionality
                    if (nextBtn) {
                        nextBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            if (choice) {
                                jsPsych.finishTrial();
                            }
                        });
                    }
                }
            };
        }

        // Create memory check questions for each image choice question
        const memory_check_question_2 = createMemoryCheck(2, 'MgG1.png');
        const memory_check_question_3 = createMemoryCheck(3, 'MgB1.png');
        const memory_check_question_4 = createMemoryCheck(4, 'MoG1.png');
        const memory_check_question_5 = createMemoryCheck(5, 'MoB2.png');
        const memory_check_question_6 = createMemoryCheck(6, 'MoG2.png');
        const memory_check_question_7 = createMemoryCheck(7, 'MgB2.png');
        const memory_check_question_8 = createMemoryCheck(8, 'MgG2.png');
        
        // Create 4 additional memory check questions
        const memory_check_question_9 = createMemoryCheck(9, 'MoNB.png');
        const memory_check_question_10 = createMemoryCheck(10, 'MgGNon1.png');
        const memory_check_question_11 = createMemoryCheck(11, 'MgBNon1.png');
        const memory_check_question_12 = createMemoryCheck(12, 'MoBNon1.png');

        // Create memory check questions timeline with randomization
        const allMemoryCheckQuestions = [
            memory_check_question_1,
            memory_check_question_2,
            memory_check_question_3,
            memory_check_question_4,
            memory_check_question_5,
            memory_check_question_6,
            memory_check_question_7,
            memory_check_question_8,
            memory_check_question_9,
            memory_check_question_10,
            memory_check_question_11,
            memory_check_question_12
        ];
        
        const memory_check_questions = {
            timeline: [
                memory_check_preparation,
                ...jsPsych.randomization.shuffle(allMemoryCheckQuestions)
            ]
        };

        // Create array of question pairs (memory check + image choice for same image)
        const questionPairs = [
                {
                    timeline: [memory_check_question_1, image_choice_question]
                },
                {
                    timeline: [memory_check_question_2, image_choice_question_2]
                },
                {
                    timeline: [memory_check_question_3, image_choice_question_3]
                },
                {
                    timeline: [memory_check_question_4, image_choice_question_4]
                },
                {
                    timeline: [memory_check_question_5, image_choice_question_5]
                },
                {
                    timeline: [memory_check_question_6, image_choice_question_6]
                },
                {
                    timeline: [memory_check_question_7, image_choice_question_7]
                },
                {
                    timeline: [memory_check_question_8, image_choice_question_8]
                }
        ];
        
        // Shuffle the question pairs using jsPsych randomization
        // This ensures pairs stay together but order of pairs is randomized
        const shuffledQuestionPairs = jsPsych.randomization.shuffle(questionPairs);
        
        // Randomized image choice questions block with memory checks
        const randomized_image_choice_questions = {
            timeline: shuffledQuestionPairs
        };



        // Very end celebration screen before final questions
        const very_end_celebration = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                    <img src="img/veryEndCeleb.png${cacheBuster}" alt="Final Celebration" style="max-width: 600px; height: auto; margin: 20px auto; display: block;">
                </div>
                <button id="custom-next-btn-very-end" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn-very-end');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        jsPsych.finishTrial();
                    });
                }
            }
        };

        // Questions page with all the required questions
        const questions_page = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="instructions" style="max-width: 900px; text-align: left;">
                    <h2 style="text-align: center; color: #333; margin-bottom: 30px;">Additional Information</h2>
                    
                    <form id="questions-form" style="display: flex; flex-direction: column; gap: 25px;">
                        <!-- Question 1: Pick one -->
                        <div class="question-group">
                            <label for="pick-one" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                1. Pick one:
                            </label>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="pick-one" value="keep-data" style="transform: scale(1.2);">
                                    <span>Keep data</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="pick-one" value="drop-data" style="transform: scale(1.2);">
                                    <span>Drop data</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="pick-one" value="test-run" style="transform: scale(1.2);">
                                    <span>Test run</span>
                                </label>
                            </div>
                        </div>

                        <!-- Question 2: Location -->
                        <div class="question-group">
                            <label for="location" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                2. Location:
                            </label>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="location" value="museum" style="transform: scale(1.2);">
                                    <span>Museum</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="location" value="other" style="transform: scale(1.2);">
                                    <span>Other</span>
                                </label>
                            </div>
                            <div id="other-location-container" style="margin-top: 10px; display: none;">
                                <input type="text" id="other-location-text" placeholder="Please specify location" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Question 3: Child's date of birth -->
                        <div class="question-group">
                            <label for="child-dob" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                3. Child's date of birth (month, day, year):
                            </label>
                            <input type="text" id="child-dob" name="child-dob" placeholder="MM/DD/YYYY" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>

                        <!-- Question 4: Test date -->
                        <div class="question-group">
                            <label for="test-date" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                4. Test date (month, day, year):
                            </label>
                            <input type="text" id="test-date" name="test-date" placeholder="MM/DD/YYYY" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>

                        <!-- Question 5: Child's gender -->
                        <div class="question-group">
                            <label for="child-gender" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                5. Child's gender:
                            </label>
                            <input type="text" id="child-gender" name="child-gender" placeholder="Please specify" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>

                        <!-- Question 6: Child's race -->
                        <div class="question-group">
                            <label for="child-race" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                6. Child's race:
                            </label>
                            <input type="text" id="child-race" name="child-race" placeholder="Please specify" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>

                        <!-- Question 7: Comments -->
                        <div class="question-group">
                            <label for="comments" style="font-weight: bold; font-size: 1.1em; color: #333; display: block; margin-bottom: 10px;">
                                7. Comments:
                            </label>
                            <textarea id="comments" name="comments" placeholder="Any additional comments or notes" 
                                      style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                        </div>
                    </form>
                </div>
                <button id="custom-next-btn" style="background-color: #2ecc40; color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 1.2em; font-weight: bold; position: fixed; right: 40px; bottom: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12); z-index: 20;">Next</button>
            `,
            choices: ['Next'],
            on_load: function() {
                const nextBtn = document.getElementById('custom-next-btn');
                const defaultNextBtn = document.querySelector('.jspsych-html-button-response-button');
                const locationRadios = document.querySelectorAll('input[name="location"]');
                const otherLocationContainer = document.getElementById('other-location-container');
                const otherLocationText = document.getElementById('other-location-text');
                
                // Hide default jsPsych button
                if (defaultNextBtn) defaultNextBtn.style.display = 'none';
                
                // Handle location radio button changes
                locationRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'other') {
                            otherLocationContainer.style.display = 'block';
                            otherLocationText.required = true;
                        } else {
                            otherLocationContainer.style.display = 'none';
                            otherLocationText.required = false;
                            otherLocationText.value = '';
                        }
                    });
                });
                
                // Next button functionality
                if (nextBtn) {
                    nextBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // Collect all form data
                        const formData = {
                            pick_one: document.querySelector('input[name="pick-one"]:checked')?.value || '',
                            location: document.querySelector('input[name="location"]:checked')?.value || '',
                            other_location: otherLocationText.value || '',
                            child_dob: document.getElementById('child-dob').value || '',
                            test_date: document.getElementById('test-date').value || '',
                            child_gender: document.getElementById('child-gender').value || '',
                            child_race: document.getElementById('child-race').value || '',
                            comments: document.getElementById('comments').value || ''
                        };
                        
                        // Add data to jsPsych
                        jsPsych.data.addProperties(formData);
                        
                        console.log('Questions data collected:', formData);
                        
                        // Collect all experiment data for download - ONE ROW PER PARTICIPANT
                        const allData = jsPsych.data.get();
                        const participantRow = {
                            participant_id: participantID,
                            data_export_timestamp: new Date().toISOString()
                        };
                        
                        // Debug: Log all available data
                        console.log('=== DEBUG: All jsPsych Data ===');
                        allData.values().forEach((trial, index) => {
                            console.log(`Trial ${index}:`, trial);
                        });
                        console.log('=== END DEBUG ===');
                        
                        // Track which trial types we've already processed to avoid duplicates
                        const processedTrials = new Set();
                        
                        // Map to store image names for memory/choice questions
                        const imageMap = {
                            1: 'MoB1',
                            2: 'MgG1',
                            3: 'MgB1',
                            4: 'MoG1',
                            5: 'MoB2',
                            6: 'MoG2',
                            7: 'MgB2',
                            8: 'MgG2',
                            9: 'MoNB',
                            10: 'MgGNon1',
                            11: 'MgBNon1',
                            12: 'MoBNon1'
                        };
                        
                        // Temporary storage for collecting complete data
                        let latestPreTrainData = null;
                        let latestTrainingData = null;
                        let latestTrialAData = null;
                        let latestTrialBData = null;
                        let latestTrial3Data = null;
                        let latestTrial4Data = null;
                        
                        allData.values().forEach(trial => {
                            console.log('Processing trial data:', trial);
                            
                            // Add demographics (will be overwritten each time, but that's OK)
                            participantRow.participant_number = trial.participant_number || '';
                            participantRow.participant_gender = trial.participant_gender || '';
                            participantRow.participant_age = trial.participant_age || '';
                            participantRow.test_date = trial.test_date || '';
                            participantRow.pick_one = trial.pick_one || '';
                            participantRow.location = trial.location || '';
                            participantRow.other_location = trial.other_location || '';
                            participantRow.child_dob = trial.child_dob || '';
                            participantRow.child_gender = trial.child_gender || '';
                            participantRow.child_race = trial.child_race || '';
                            participantRow.comments = trial.comments || '';
                            
                            // Collect pre-training data (keep latest/most complete version)
                            if (trial.found_differences_preTrain !== undefined) {
                                latestPreTrainData = {
                                    found_differences: trial.found_differences_preTrain || [],
                                    found_times: trial.found_times_preTrain || [],
                                    start_time: trial.start_time_preTrain || '',
                                    end_time: trial.end_time_preTrain || '',
                                    total_found: trial.total_found_preTrain || 0
                                };
                                console.log('Collected preTrain data:', latestPreTrainData);
                            }
                            
                            // Collect training data
                            if (trial.found_differences_training !== undefined) {
                                latestTrainingData = {
                                    found_differences: trial.found_differences_training || [],
                                    found_times: trial.found_times_training || [],
                                    start_time: trial.start_time_training || '',
                                    end_time: trial.end_time_training || '',
                                    total_found: trial.total_found_training || 0
                                };
                                console.log('Collected training data:', latestTrainingData);
                            }
                            
                            // Collect trial A data
                            if (trial.found_differences_A !== undefined) {
                                latestTrialAData = {
                                    found_differences: trial.found_differences_A || [],
                                    found_times: trial.found_times_A || [],
                                    start_time: trial.start_time_A || '',
                                    end_time: trial.end_time_A || '',
                                    total_found: trial.total_found_A || 0
                                };
                                console.log('Collected trialA data:', latestTrialAData);
                            }
                            
                            // Collect trial B data
                            if (trial.found_differences_B !== undefined) {
                                latestTrialBData = {
                                    found_differences: trial.found_differences_B || [],
                                    found_times: trial.found_times_B || [],
                                    start_time: trial.start_time_B || '',
                                    end_time: trial.end_time_B || '',
                                    total_found: trial.total_found_B || 0
                                };
                                console.log('Collected trialB data:', latestTrialBData);
                            }
                            
                            // Collect trial 3 data
                            if (trial.found_differences_3 !== undefined) {
                                latestTrial3Data = {
                                    found_differences: trial.found_differences_3 || [],
                                    found_times: trial.found_times_3 || [],
                                    start_time: trial.start_time_3 || '',
                                    end_time: trial.end_time_3 || '',
                                    total_found: trial.total_found_3 || 0
                                };
                                console.log('Collected trial3 data:', latestTrial3Data);
                            }

                            // Collect trial 4 data (new)
                            if (trial.found_differences_4new !== undefined) {
                                latestTrial4Data = {
                                    found_differences: trial.found_differences_4new || [],
                                    found_times: trial.found_times_4new || [],
                                    start_time: trial.start_time_4new || '',
                                    end_time: trial.end_time_4new || '',
                                    total_found: trial.total_found_4new || 0
                                };
                                console.log('Collected trial4 data:', latestTrial4Data);
                            }

                            // Process memory check questions - use image names directly for column names
                            for (let i = 1; i <= 12; i++) {
                                const memoryCheckKey = `memory_check_${i}`;
                                const memoryCheckImageKey = `memory_check_${i}_image`;
                                const imageChoiceKey = i === 1 ? 'image_choice_question' : `image_choice_question_${i}`;
                                
                                // Capture memory check data using image name for column
                                if (trial[memoryCheckKey] !== undefined && !processedTrials.has(`memory_check_${i}`)) {
                                    processedTrials.add(`memory_check_${i}`);
                                    const imageName = trial[memoryCheckImageKey] || imageMap[i] || '';
                                    if (imageName) {
                                        participantRow[`memoryCheck_${imageName}`] = trial[memoryCheckKey] || '';
                                    }
                                }
                                
                                // Capture image choice data if it exists (only for first 8)
                                if (i <= 8) {
                                    const imageName = imageMap[i];
                                    if (trial[imageChoiceKey] !== undefined && !processedTrials.has(`image_choice_${i}`)) {
                                        processedTrials.add(`image_choice_${i}`);
                                        participantRow[`gamePref_${imageName}`] = trial[imageChoiceKey] || '';
                                    }
                                }
                            }
                            
                            // Process induction strength questions
                            if (trial.greenMippoIndStren_choice !== undefined && !processedTrials.has('green_mippo_choice')) {
                                processedTrials.add('green_mippo_choice');
                                participantRow.indStren_greenMippo = trial.greenMippoIndStren_choice || '';
                            }
                            
                            if (trial.orangeTuvvyIndStren_choice !== undefined && !processedTrials.has('orange_tuvvy_choice')) {
                                processedTrials.add('orange_tuvvy_choice');
                                participantRow.indStren_orangeTuvvy = trial.orangeTuvvyIndStren_choice || '';
                            }
                            
                            // Process repeat questions (after forced choice)
                            if (trial.greenMippoIndStren_choice_repeat !== undefined && !processedTrials.has('green_mippo_choice_repeat')) {
                                processedTrials.add('green_mippo_choice_repeat');
                                participantRow.indStren_greenMippo_repeat = trial.greenMippoIndStren_choice_repeat || '';
                            }
                            
                            if (trial.orangeTuvvyIndStren_choice_repeat !== undefined && !processedTrials.has('orange_tuvvy_choice_repeat')) {
                                processedTrials.add('orange_tuvvy_choice_repeat');
                                participantRow.indStren_orangeTuvvy_repeat = trial.orangeTuvvyIndStren_choice_repeat || '';
                            }
                        });
                        
                        // Now process the collected data AFTER loop completes
                        console.log('=== Processing collected spot-the-difference data ===');
                        
                        // Process pre-training data
                        if (latestPreTrainData) {
                            console.log('Final preTrain data to process:', latestPreTrainData);
                            participantRow.std_preTrain_start_time = latestPreTrainData.start_time;
                            participantRow.std_preTrain_end_time = latestPreTrainData.end_time;
                            participantRow.std_preTrain_total_found = latestPreTrainData.total_found;
                            
                            for (let i = 1; i <= 4; i++) {
                                const foundIndex = latestPreTrainData.found_differences.indexOf(String(i));
                                participantRow[`std_preTrain_diff${i}_found`] = foundIndex !== -1 ? 'yes' : 'no';
                                participantRow[`std_preTrain_diff${i}_time_seconds`] = foundIndex !== -1 ? (latestPreTrainData.found_times[foundIndex] || '') : '';
                                participantRow[`std_preTrain_diff${i}_order`] = foundIndex !== -1 ? (foundIndex + 1) : '';
                            }
                        }
                        
                        // Process training data
                        if (latestTrainingData) {
                            console.log('Final training data to process:', latestTrainingData);
                            participantRow.std_training_start_time = latestTrainingData.start_time;
                            participantRow.std_training_end_time = latestTrainingData.end_time;
                            participantRow.std_training_total_found = latestTrainingData.total_found;
                            
                            for (let i = 1; i <= 4; i++) {
                                const foundIndex = latestTrainingData.found_differences.indexOf(String(i));
                                participantRow[`std_training_diff${i}_found`] = foundIndex !== -1 ? 'yes' : 'no';
                                participantRow[`std_training_diff${i}_time_seconds`] = foundIndex !== -1 ? (latestTrainingData.found_times[foundIndex] || '') : '';
                                participantRow[`std_training_diff${i}_order`] = foundIndex !== -1 ? (foundIndex + 1) : '';
                            }
                        }
                        
                        // Process trial A data
                        if (latestTrialAData) {
                            console.log('Final trialA data to process:', latestTrialAData);
                            participantRow.std_trialA_start_time = latestTrialAData.start_time;
                            participantRow.std_trialA_end_time = latestTrialAData.end_time;
                            participantRow.std_trialA_total_found = latestTrialAData.total_found;
                            
                            for (let i = 1; i <= 6; i++) {
                                const foundIndex = latestTrialAData.found_differences.indexOf(String(i));
                                participantRow[`std_trialA_diff${i}_found`] = foundIndex !== -1 ? 'yes' : 'no';
                                participantRow[`std_trialA_diff${i}_time_seconds`] = foundIndex !== -1 ? (latestTrialAData.found_times[foundIndex] || '') : '';
                                participantRow[`std_trialA_diff${i}_order`] = foundIndex !== -1 ? (foundIndex + 1) : '';
                            }
                        }
                        
                        // Process trial B data
                        if (latestTrialBData) {
                            console.log('Final trialB data to process:', latestTrialBData);
                            participantRow.std_trialB_start_time = latestTrialBData.start_time;
                            participantRow.std_trialB_end_time = latestTrialBData.end_time;
                            participantRow.std_trialB_total_found = latestTrialBData.total_found;
                            
                            for (let i = 1; i <= 6; i++) {
                                const foundIndex = latestTrialBData.found_differences.indexOf(String(i));
                                participantRow[`std_trialB_diff${i}_found`] = foundIndex !== -1 ? 'yes' : 'no';
                                participantRow[`std_trialB_diff${i}_time_seconds`] = foundIndex !== -1 ? (latestTrialBData.found_times[foundIndex] || '') : '';
                                participantRow[`std_trialB_diff${i}_order`] = foundIndex !== -1 ? (foundIndex + 1) : '';
                            }
                        }

                        // Process trial 3 data
                        if (latestTrial3Data) {
                            console.log('Final trial3 data to process:', latestTrial3Data);
                            participantRow.std_trial3_start_time = latestTrial3Data.start_time;
                            participantRow.std_trial3_end_time = latestTrial3Data.end_time;
                            participantRow.std_trial3_total_found = latestTrial3Data.total_found;
                            for (let i = 1; i <= 6; i++) {
                                const foundIndex = latestTrial3Data.found_differences.indexOf(String(i));
                                participantRow[`std_trial3_diff${i}_found`] = foundIndex !== -1 ? 'yes' : 'no';
                                participantRow[`std_trial3_diff${i}_time_seconds`] = foundIndex !== -1 ? (latestTrial3Data.found_times[foundIndex] || '') : '';
                                participantRow[`std_trial3_diff${i}_order`] = foundIndex !== -1 ? (foundIndex + 1) : '';
                            }
                        }

                        // Process trial 4 data
                        if (latestTrial4Data) {
                            console.log('Final trial4 data to process:', latestTrial4Data);
                            participantRow.std_trial4_start_time = latestTrial4Data.start_time;
                            participantRow.std_trial4_end_time = latestTrial4Data.end_time;
                            participantRow.std_trial4_total_found = latestTrial4Data.total_found;
                            for (let i = 1; i <= 6; i++) {
                                const foundIndex = latestTrial4Data.found_differences.indexOf(String(i));
                                participantRow[`std_trial4_diff${i}_found`] = foundIndex !== -1 ? 'yes' : 'no';
                                participantRow[`std_trial4_diff${i}_time_seconds`] = foundIndex !== -1 ? (latestTrial4Data.found_times[foundIndex] || '') : '';
                                participantRow[`std_trial4_diff${i}_order`] = foundIndex !== -1 ? (foundIndex + 1) : '';
                            }
                        }

                        // Compute explicit trial order label based on start times (A, B, 3, 4)
                        (function computeTrialOrder() {
                            const entries = [];
                            if (latestTrialAData && latestTrialAData.start_time) entries.push(['A', latestTrialAData.start_time]);
                            if (latestTrialBData && latestTrialBData.start_time) entries.push(['B', latestTrialBData.start_time]);
                            if (latestTrial3Data && latestTrial3Data.start_time) entries.push(['3', latestTrial3Data.start_time]);
                            if (latestTrial4Data && latestTrial4Data.start_time) entries.push(['4', latestTrial4Data.start_time]);
                            if (entries.length > 0) {
                                entries.sort((a, b) => (a[1] || 0) - (b[1] || 0));
                                participantRow.std_trial_order = entries.map(e => e[0]).join('>');
                            }
                        })();
                        
                        // Debug: Log final participantRow
                        console.log('=== FINAL participantRow ===');
                        console.log('Participant row:', participantRow);
                        console.log('=== END participantRow ===');
                        
                        // Create CSV content - ONE ROW PER PARTICIPANT
                        let csvContent = "data:text/csv;charset=utf-8,";
                        
                        // Get all keys from participantRow to create headers
                        const headers = Object.keys(participantRow);
                        csvContent += headers.join(',') + '\n';
                        
                        // Add the single data row
                        const values = headers.map(key => {
                            const value = participantRow[key] || '';
                            // Escape commas in values by wrapping in quotes
                            return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                        });
                        csvContent += values.join(',') + '\n';
                        
                        // Create and trigger download
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement('a');
                        link.setAttribute('href', encodedUri);
                        link.setAttribute('download', `experiment_data_${participantID}_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        console.log('Data download completed');
                        
                        // Advance to next trial
                        jsPsych.finishTrial();
                    });
                }
            }
        };

        // Timeline for after training (always runs)


        // Create conditional timeline structure
        const conditional_timeline = {
            timeline: [
                // Normal path: only the required blocks
                {
                    timeline: [
                        clap_block,
                        randomized_middle_trials,
                        memory_check_questions,
                        clap_celebration,
                        very_end_celebration,
                        questions_page
                    ],
                    conditional_function: function() {
                        // Show normal trials if differences were found in training
                        const currentData = jsPsych.data.get().values()[0];
                        return currentData.skip_to_very_end !== true;
                    }
                },
                // Skip path: go directly to veryEndCelebration
                {
                    timeline: [
                        very_end_celebration,
                        questions_page
                    ],
                    conditional_function: function() {
                        // Skip to very end if no differences were found in training
                        const currentData = jsPsych.data.get().values()[0];
                        return currentData.skip_to_very_end === true;
                    }
                }
            ]
        };





        // Add spot-the-difference blocks to the existing timeline
        timeline.push(preload);
        timeline.push(introductionStD_A);
        timeline.push(holder_block);
        timeline.push(clap_block);
        timeline.push(preTrain_training_task);
        timeline.push(clap_block_after_preTrain);
        timeline.push(training_task);

        timeline.push(conditional_timeline);





        // Function to handle hotspot clicks for preTrain training
        function handleHotspotClickPreTrain(diffId, hotspotElement, localDifferences) {
            const currentData = jsPsych.data.get().values()[0];
            const foundDifferences = currentData.found_differences_preTrain || [];
            const foundTimes = currentData.found_times_preTrain || [];
            
            // Find the difference in the local differences array
            const diff = localDifferences.find(d => d.id == diffId);
            
            if (!diff) {
                return;
            }
            
            const isFirstClick = !foundDifferences.includes(diffId);
            
            if (isFirstClick) {
                // First time clicking this difference
                foundDifferences.push(diffId);
                diff.found = true;
                hotspotElement.classList.add('found');
                
                // Play correct audio
                const audio = new Audio('mp3/correct.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                // Update data
                const now = Date.now();
                const relTime = ((now - currentData.start_time_preTrain) / 1000).toFixed(2);
                foundTimes.push(relTime);
                jsPsych.data.addProperties({
                    found_differences_preTrain: foundDifferences,
                    found_times_preTrain: foundTimes,
                    last_clicked_preTrain: diffId,
                    click_time_preTrain: now,
                    was_first_click_preTrain: true
                });
                
                // Check if all differences are found and enable Next button
                if (foundDifferences.length === localDifferences.length) {
                    const nextBtn = document.getElementById('preTrain-next-btn');
                    if (nextBtn) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.pointerEvents = 'auto';
                    }
                }
                
                // First time clicking this difference
            } else {
                // Already clicked this difference
                const audio = new Audio('mp3/gotItAlready.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                jsPsych.data.addProperties({
                    last_clicked_preTrain: diffId,
                    was_first_click_preTrain: false
                });
            }
            
            // Note: Completion logic moved to individual difference click handler above
        }

        // Function to handle hotspot clicks for training
        function handleHotspotClickTraining(diffId, hotspotElement, localDifferences) {
            const currentData = jsPsych.data.get().values()[0];
            const foundDifferences = currentData.found_differences_training || [];
            const foundTimes = currentData.found_times_training || [];
            

            
            // Find the difference in the local differences array
            const diff = localDifferences.find(d => d.id == diffId);
            
            if (!diff) {
                return;
            }
            
            const isFirstClick = !foundDifferences.includes(diffId);
            
            if (isFirstClick) {
                // First time clicking this difference
                foundDifferences.push(diffId);
                diff.found = true;
                hotspotElement.classList.add('found');
                

                
                // Play correct audio
                const audio = new Audio('mp3/correct.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                // Update data
                const now = Date.now();
                const relTime = ((now - currentData.start_time_training) / 1000).toFixed(2);
                foundTimes.push(relTime);
                jsPsych.data.addProperties({
                    found_differences_training: foundDifferences,
                    found_times_training: foundTimes,
                    last_clicked_training: diffId,
                    click_time_training: now,
                    was_first_click_training: true
                });
                
                // First time clicking this difference
            } else {
                // Already clicked this difference
                const audio = new Audio('mp3/gotItAlready.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                jsPsych.data.addProperties({
                    last_clicked_training: diffId,
                    click_time_training: Date.now(),
                    was_first_click_training: false
                });
            }
            
            // Check if all differences are found (training has 4 differences)
            if (foundDifferences.length === 4) {
                // Add final data properties before ending trial
                jsPsych.data.addProperties({
                    end_time_training: Date.now(),
                    total_found_training: foundDifferences.length
                });
                // End trial early when all differences are found
                setTimeout(() => {
                    if (window.safeFinishTrainingTrial) {
                        window.safeFinishTrainingTrial();
                    } else {
                        jsPsych.finishTrial();
                    }
                }, 1000); // 1 second delay to show completion
            }
        }

        // Function to handle hotspot clicks for trial A
        function handleHotspotClickA(diffId, hotspotElement) {
            const currentData = jsPsych.data.get().values()[0];
            const foundDifferences = currentData.found_differences_A || [];
            const foundTimes = currentData.found_times_A || [];
            const diff = differencesA.find(d => d.id == diffId);
            
            if (!diff) {
                return;
            }
            
            const isFirstClick = !foundDifferences.includes(diffId);
            
            if (isFirstClick) {
                foundDifferences.push(diffId);
                diff.found = true;
                hotspotElement.classList.add('found');
                
                const audio = new Audio('mp3/correct.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                const now = Date.now();
                const relTime = ((now - currentData.start_time_A) / 1000).toFixed(2);
                foundTimes.push(relTime);
                jsPsych.data.addProperties({
                    found_differences_A: foundDifferences,
                    found_times_A: foundTimes,
                    last_clicked_A: diffId,
                    click_time_A: now,
                    was_first_click_A: true
                });
                
                console.log(`First click on difference ${diffId} in trial A. Total found: ${foundDifferences.length}`);
            } else {
                const audio = new Audio('mp3/gotItAlready.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                jsPsych.data.addProperties({
                    last_clicked_A: diffId,
                    click_time_A: Date.now(),
                    was_first_click_A: false
                });
                
                console.log(`Repeat click on difference ${diffId} in trial A. Total found: ${foundDifferences.length}`);
            }
            
            if (foundDifferences.length === 6) {
                console.log('All 6 differences found in trial A! Ending trial early.');
                // Add final data properties before ending trial
                jsPsych.data.addProperties({
                    end_time_A: Date.now(),
                    total_found_A: foundDifferences.length
                });
                setTimeout(() => {
                    console.log('Calling jsPsych.finishTrial() for trial A - all differences found');
                    // Clear timer before ending trial
                    if (window.trialATimer) {
                        clearInterval(window.trialATimer);
                        window.trialATimer = null;
                    }
                    jsPsych.finishTrial();
                }, 1000);
            }
        }

        // Function to handle hotspot clicks for trial B
        function handleHotspotClickB(diffId, hotspotElement) {
            const currentData = jsPsych.data.get().values()[0];
            const foundDifferences = currentData.found_differences_B || [];
            const foundTimes = currentData.found_times_B || [];
            const diff = differencesB.find(d => d.id == diffId);
            
            if (!diff) {
                return;
            }
            
            const isFirstClick = !foundDifferences.includes(diffId);
            
            if (isFirstClick) {
                foundDifferences.push(diffId);
                diff.found = true;
                hotspotElement.classList.add('found');
                
                const audio = new Audio('mp3/correct.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                const now = Date.now();
                const relTime = ((now - currentData.start_time_B) / 1000).toFixed(2);
                foundTimes.push(relTime);
                jsPsych.data.addProperties({
                    found_differences_B: foundDifferences,
                    found_times_B: foundTimes,
                    last_clicked_B: diffId,
                    click_time_B: now,
                    was_first_click_B: true
                });
                
                console.log(`First click on difference ${diffId} in trial B. Total found: ${foundDifferences.length}`);
            } else {
                const audio = new Audio('mp3/gotItAlready.mp3' + cacheBuster);
                audio.play().catch(e => console.log('Audio play error:', e));
                
                jsPsych.data.addProperties({
                    last_clicked_B: diffId,
                    click_time_B: Date.now(),
                    was_first_click_B: false
                });
                
                console.log(`Repeat click on difference ${diffId} in trial B. Total found: ${foundDifferences.length}`);
            }
            
            if (foundDifferences.length === 6) {
                console.log('All 6 differences found in trial B! Ending trial early.');
                // Add final data properties before ending trial
                jsPsych.data.addProperties({
                    end_time_B: Date.now(),
                    total_found_B: foundDifferences.length
                });
                setTimeout(() => {
                    console.log('Calling jsPsych.finishTrial() for trial B - all differences found');
                    // Clear timer before ending trial
                    if (window.trialBTimer) {
                        clearInterval(window.trialBTimer);
                        window.trialBTimer = null;
                    }
                    jsPsych.finishTrial();
                }, 1000);
            }
        }


        // Function to handle hotspot clicks for trial 3
        function handleHotspotClick3(diffId, hotspotElement) {
            const currentData = jsPsych.data.get().values()[0];
            const foundDifferences = currentData.found_differences_3 || [];
            const foundTimes = currentData.found_times_3 || [];
            const diff = differences3.find(d => d.id == diffId);
            if (!diff) return;
            const isFirstClick = !foundDifferences.includes(diffId);
            if (isFirstClick) {
                foundDifferences.push(diffId);
                diff.found = true;
                hotspotElement.classList.add('found');
                new Audio('mp3/correct.mp3' + cacheBuster).play().catch(() => {});
                const now = Date.now();
                const relTime = ((now - currentData.start_time_3) / 1000).toFixed(2);
                foundTimes.push(relTime);
                jsPsych.data.addProperties({
                    found_differences_3: foundDifferences,
                    found_times_3: foundTimes,
                    last_clicked_3: diffId,
                    click_time_3: now,
                    was_first_click_3: true
                });
            } else {
                new Audio('mp3/gotItAlready.mp3' + cacheBuster).play().catch(() => {});
                jsPsych.data.addProperties({
                    last_clicked_3: diffId,
                    click_time_3: Date.now(),
                    was_first_click_3: false
                });
            }
            if (foundDifferences.length === 6) {
                jsPsych.data.addProperties({ end_time_3: Date.now(), total_found_3: foundDifferences.length });
                setTimeout(() => {
                    if (window.trial3Timer) { clearInterval(window.trial3Timer); window.trial3Timer = null; }
                    jsPsych.finishTrial();
                }, 1000);
            }
        }

        // Function to handle hotspot clicks for trial 4
        function handleHotspotClick4(diffId, hotspotElement) {
            const currentData = jsPsych.data.get().values()[0];
            const foundDifferences = currentData.found_differences_4new || [];
            const foundTimes = currentData.found_times_4new || [];
            const diff = differences4.find(d => d.id == diffId);
            if (!diff) return;
            const isFirstClick = !foundDifferences.includes(diffId);
            if (isFirstClick) {
                foundDifferences.push(diffId);
                diff.found = true;
                hotspotElement.classList.add('found');
                new Audio('mp3/correct.mp3' + cacheBuster).play().catch(() => {});
                const now = Date.now();
                const relTime = ((now - currentData.start_time_4new) / 1000).toFixed(2);
                foundTimes.push(relTime);
                jsPsych.data.addProperties({
                    found_differences_4new: foundDifferences,
                    found_times_4new: foundTimes,
                    last_clicked_4new: diffId,
                    click_time_4new: now,
                    was_first_click_4new: true
                });
            } else {
                new Audio('mp3/gotItAlready.mp3' + cacheBuster).play().catch(() => {});
                jsPsych.data.addProperties({
                    last_clicked_4new: diffId,
                    click_time_4new: Date.now(),
                    was_first_click_4new: false
                });
            }
            if (foundDifferences.length === 6) {
                jsPsych.data.addProperties({ end_time_4new: Date.now(), total_found_4new: foundDifferences.length });
                setTimeout(() => {
                    if (window.trial4Timer) { clearInterval(window.trial4Timer); window.trial4Timer = null; }
                    jsPsych.finishTrial();
                }, 1000);
            }
        }

        // Timer functions

        function startTimerPreTrain() {
            // Timer function disabled for Pre-Training trial
            // Trial will continue until all differences are found
            console.log('Pre-Training trial: No time limit - continue until all differences found');
        }

        function startTimerTraining() {
            const timerElement = document.getElementById('timerTraining');
            if (!timerElement) {
                return;
            }
            const startTime = Date.now();
            const duration = 90000; // 90 seconds

            const timer = setInterval(() => {
                // Check if timer element still exists (trial might have ended)
                if (!document.getElementById('timerTraining')) {
                    clearInterval(timer);
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, Math.ceil((duration - elapsed) / 1000));
                
                timerElement.textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(timer);
                    if (window.safeFinishTrainingTrial) {
                        window.safeFinishTrainingTrial();
                    } else {
                        jsPsych.finishTrial();
                    }
                }
            }, 1000);
            
            // Store timer reference
            window.trainingTimer = timer;
        }


        function startTimerA() {
            const timerElement = document.getElementById('timerA');
            if (!timerElement) {
                console.log('Timer element for trial A not found - trial may have ended');
                return;
            }
            const startTime = Date.now();
            const duration = 90000; // 90 seconds
            console.log('Starting timer for trial A - 90 seconds');

            const timer = setInterval(() => {
                // Check if timer element still exists (trial might have ended)
                if (!document.getElementById('timerA')) {
                    console.log('Timer element for trial A no longer exists - clearing timer');
                    clearInterval(timer);
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, Math.ceil((duration - elapsed) / 1000));
                
                timerElement.textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(timer);
                    console.log('Timer expired for trial A - calling jsPsych.finishTrial()');
                    jsPsych.finishTrial();
                }
            }, 1000);
            
            // Store timer reference for debugging
            window.trialATimer = timer;
        }

        function startTimerB() {
            const timerElement = document.getElementById('timerB');
            if (!timerElement) {
                console.log('Timer element for trial B not found - trial may have ended');
                return;
            }
            const startTime = Date.now();
            const duration = 90000; // 90 seconds
            console.log('Starting timer for trial B - 90 seconds');

            const timer = setInterval(() => {
                // Check if timer element still exists (trial might have ended)
                if (!document.getElementById('timerB')) {
                    console.log('Timer element for trial B no longer exists - clearing timer');
                    clearInterval(timer);
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, Math.ceil((duration - elapsed) / 1000));
                
                timerElement.textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(timer);
                    console.log('Timer expired for trial B - calling jsPsych.finishTrial()');
                    jsPsych.finishTrial();
                }
            }, 1000);
            
            // Store timer reference for debugging
            window.trialBTimer = timer;
        }


        function startTimer3() {
            const timerElement = document.getElementById('timer3');
            if (!timerElement) return;
            const startTime = Date.now();
            const duration = 90000;
            const timer = setInterval(() => {
                if (!document.getElementById('timer3')) { clearInterval(timer); return; }
                const remaining = Math.max(0, Math.ceil((duration - (Date.now() - startTime)) / 1000));
                timerElement.textContent = remaining;
                if (remaining <= 0) {
                    clearInterval(timer);
                    jsPsych.finishTrial();
                }
            }, 1000);
            window.trial3Timer = timer;
        }

        function startTimer4() {
            const timerElement = document.getElementById('timer4');
            if (!timerElement) return;
            const startTime = Date.now();
            const duration = 90000;
            const timer = setInterval(() => {
                if (!document.getElementById('timer4')) { clearInterval(timer); return; }
                const remaining = Math.max(0, Math.ceil((duration - (Date.now() - startTime)) / 1000));
                timerElement.textContent = remaining;
                if (remaining <= 0) {
                    clearInterval(timer);
                    jsPsych.finishTrial();
                }
            }, 1000);
            window.trial4Timer = timer;
        }




     // === END SPOTTHEDIFFERENCE BLOCK ===

        // Run the experiment
        console.log('Starting spot-the-difference experiment...');
        jsPsych.run(timeline);
    </script>
</body>
</html>